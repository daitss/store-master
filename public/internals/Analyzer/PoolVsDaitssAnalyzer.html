<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Analyzer::PoolVsDaitssAnalyzer
  
    &mdash; Storage Master Service
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (P)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Analyzer.html" title="Analyzer (module)">Analyzer</a></span></span>
     &raquo; 
    <span class="title">PoolVsDaitssAnalyzer</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Analyzer::PoolVsDaitssAnalyzer
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Analyzer::PoolVsDaitssAnalyzer</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb</dd>
  
</dl>
<div class="clear"></div>



  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#reports-instance_method" title="#reports (instance method)">- (Object) <strong>reports</strong> </a>
    

    
  </span>
  
  
    <span class="note title readonly">readonly</span>
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute reports.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#anything_interesting%3F-instance_method" title="#anything_interesting? (instance method)">- (Boolean) <strong>anything_interesting?</strong>(reports) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#fixity_issues-instance_method" title="#fixity_issues (instance method)">- (Object) <strong>fixity_issues</strong>(url, pool_data, daitss_data) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_package-instance_method" title="#get_package (instance method)">- (Object) <strong>get_package</strong>(url) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#indent-instance_method" title="#indent (instance method)">- (Object) <strong>indent</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (PoolVsDaitssAnalyzer) <strong>initialize</strong>(pool_fixity_streams, daitss_fixity_stream, required_copies, expiration_days, stale_days, no_later_than) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of PoolVsDaitssAnalyzer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#missing_issues-instance_method" title="#missing_issues (instance method)">- (Object) <strong>missing_issues</strong>(url, pool_data_array) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#pluralize-instance_method" title="#pluralize (instance method)">- (Object) <strong>pluralize</strong>(count, singular, plural) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run-instance_method" title="#run (instance method)">- (Object) <strong>run</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Analyzer::PoolVsDaitssAnalyzer (class)">PoolVsDaitssAnalyzer</a></span></tt>) <strong>initialize</strong>(pool_fixity_streams, daitss_fixity_stream, required_copies, expiration_days, stale_days, no_later_than) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>A new instance of PoolVsDaitssAnalyzer</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 62</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span>  <span class='pool_fixity_streams identifier id'>pool_fixity_streams</span><span class='comma token'>,</span> <span class='daitss_fixity_stream identifier id'>daitss_fixity_stream</span><span class='comma token'>,</span> <span class='required_copies identifier id'>required_copies</span><span class='comma token'>,</span> <span class='expiration_days identifier id'>expiration_days</span><span class='comma token'>,</span> <span class='stale_days identifier id'>stale_days</span><span class='comma token'>,</span> <span class='no_later_than identifier id'>no_later_than</span>
  
  <span class='@pool_fixity_stream ivar id'>@pool_fixity_stream</span>    <span class='assign token'>=</span> <span class='Streams constant id'>Streams</span><span class='colon2 op'>::</span><span class='StoreUrlMultiFixities constant id'>StoreUrlMultiFixities</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='pool_fixity_streams identifier id'>pool_fixity_streams</span><span class='rparen token'>)</span>
  <span class='@daitss_fixity_stream ivar id'>@daitss_fixity_stream</span>  <span class='assign token'>=</span> <span class='daitss_fixity_stream identifier id'>daitss_fixity_stream</span>

  <span class='@cutoff_time ivar id'>@cutoff_time</span>         <span class='assign token'>=</span> <span class='no_later_than identifier id'>no_later_than</span>
  <span class='@required_copies ivar id'>@required_copies</span>     <span class='assign token'>=</span> <span class='required_copies identifier id'>required_copies</span>
  <span class='@expiration_days ivar id'>@expiration_days</span>     <span class='assign token'>=</span> <span class='expiration_days identifier id'>expiration_days</span>

  <span class='@report_integrity ivar id'>@report_integrity</span>    <span class='assign token'>=</span> <span class='Datyl constant id'>Datyl</span><span class='colon2 op'>::</span><span class='Reporter constant id'>Reporter</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='string val'>&quot;Integrity Errors&quot;</span><span class='comma token'>,</span>    <span class='string val'>&quot;Package Copies Missing From Silo Pools&quot;</span>
  <span class='@report_too_many ivar id'>@report_too_many</span>     <span class='assign token'>=</span> <span class='Datyl constant id'>Datyl</span><span class='colon2 op'>::</span><span class='Reporter constant id'>Reporter</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='string val'>&quot;Integrity Errors&quot;</span><span class='comma token'>,</span>    <span class='string val'>&quot;Too Many Copies Of Packages&quot;</span>
  <span class='@report_fixity ivar id'>@report_fixity</span>       <span class='assign token'>=</span> <span class='Datyl constant id'>Datyl</span><span class='colon2 op'>::</span><span class='Reporter constant id'>Reporter</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='string val'>&quot;Fixity Errors&quot;</span><span class='comma token'>,</span>       <span class='string val'>&quot;Package Copies With Fixity Errors&quot;</span>
  <span class='@report_expired ivar id'>@report_expired</span>      <span class='assign token'>=</span> <span class='Datyl constant id'>Datyl</span><span class='colon2 op'>::</span><span class='Reporter constant id'>Reporter</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='string val'>&quot;Fixity Expirations&quot;</span><span class='comma token'>,</span>  <span class='dstring node'>&quot;Package Copies With Fixities Over #{expiration_days} Days Old&quot;</span>
  <span class='@report_orphaned ivar id'>@report_orphaned</span>     <span class='assign token'>=</span> <span class='Datyl constant id'>Datyl</span><span class='colon2 op'>::</span><span class='Reporter constant id'>Reporter</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='string val'>&quot;Unexpected Packages&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;Pools Contain Packages Not Listed By DAITSS&quot;</span>
  <span class='@report_summary ivar id'>@report_summary</span>      <span class='assign token'>=</span> <span class='Datyl constant id'>Datyl</span><span class='colon2 op'>::</span><span class='Reporter constant id'>Reporter</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='string val'>&quot;Summary of DAITSS Package Fixity Checks&quot;</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Requiring #{@required_copies} #{FixityUtils.pluralize(@required_copies, 'Copy', 'Copies')} Per Package&quot;</span>

  <span class='@reports ivar id'>@reports</span>             <span class='assign token'>=</span> <span class='lbrack token'>[</span> <span class='@report_summary ivar id'>@report_summary</span><span class='comma token'>,</span> <span class='@report_fixity ivar id'>@report_fixity</span><span class='comma token'>,</span> <span class='@report_integrity ivar id'>@report_integrity</span><span class='comma token'>,</span> <span class='@report_too_many ivar id'>@report_too_many</span><span class='comma token'>,</span> <span class='@report_orphaned ivar id'>@report_orphaned</span><span class='comma token'>,</span> <span class='@report_expired ivar id'>@report_expired</span> <span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <span id="reports-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="reports-instance_method">
  
    - (<tt>Object</tt>) <strong>reports</strong>  <span class="extras">(readonly)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute reports</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 60</span>

<span class='def def kw'>def</span> <span class='reports identifier id'>reports</span>
  <span class='@reports ivar id'>@reports</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="anything_interesting?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>anything_interesting?</strong>(reports) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


131
132
133
134</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 131</span>

<span class='def def kw'>def</span> <span class='anything_interesting? fid id'>anything_interesting?</span> <span class='reports identifier id'>reports</span>
  <span class='reports identifier id'>reports</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rep identifier id'>rep</span><span class='bitor op'>|</span> <span class='return return kw'>return</span> <span class='true true kw'>true</span> <span class='if if_mod kw'>if</span> <span class='rep identifier id'>rep</span><span class='dot token'>.</span><span class='interesting? fid id'>interesting?</span> <span class='rbrace token'>}</span>
  <span class='return return kw'>return</span> <span class='false false kw'>false</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="fixity_issues-instance_method">
  
    - (<tt>Object</tt>) <strong>fixity_issues</strong>(url, pool_data, daitss_data) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 106</span>

<span class='def def kw'>def</span> <span class='fixity_issues identifier id'>fixity_issues</span> <span class='url identifier id'>url</span><span class='comma token'>,</span> <span class='pool_data identifier id'>pool_data</span><span class='comma token'>,</span> <span class='daitss_data identifier id'>daitss_data</span>
  <span class='messages identifier id'>messages</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='pool_data identifier id'>pool_data</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span>
    <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='status identifier id'>status</span> <span class='eq op'>==</span> <span class='string val'>&quot;missing&quot;</span>   <span class='comment val'># this indicates a missing package; we'll report it as an integrity error elsewhere</span>

    <span class='if if kw'>if</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='sha1 identifier id'>sha1</span> <span class='neq op'>!=</span> <span class='daitss_data identifier id'>daitss_data</span><span class='dot token'>.</span><span class='sha1 identifier id'>sha1</span>
      <span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='indent identifier id'>indent</span> <span class='plus op'>+</span> <span class='dstring node'>&quot;DAITSS DB has SHA1 of #{daitss_data.sha1}, but silo at #{rec.location} reports #{rec.sha1}&quot;</span>
    <span class='end end kw'>end</span>
    <span class='if if kw'>if</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='md5 identifier id'>md5</span> <span class='neq op'>!=</span> <span class='daitss_data identifier id'>daitss_data</span><span class='dot token'>.</span><span class='md5 identifier id'>md5</span>
      <span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='indent identifier id'>indent</span> <span class='plus op'>+</span> <span class='dstring node'>&quot;DAITSS DB has MD5 of #{daitss_data.md5}, but silo at #{rec.location} reports #{rec.md5}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
  <span class='return return kw'>return</span> <span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='unshift identifier id'>unshift</span> <span class='dstring node'>&quot;#{url} checksum errors:&quot;</span>        

<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get_package-instance_method">
  
    - (<tt>Object</tt>) <strong>get_package</strong>(url) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


136
137
138
139
140
141
142</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 136</span>

<span class='def def kw'>def</span> <span class='get_package identifier id'>get_package</span> <span class='url identifier id'>url</span>
  <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='Daitss constant id'>Daitss</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='lookup_from_url identifier id'>lookup_from_url</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='rparen token'>)</span>
  <span class='if if kw'>if</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='Datyl constant id'>Datyl</span><span class='colon2 op'>::</span><span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;#{url} is no longer in the DAITSS DB; it was deleted by DAITSS during fixity record reconciliation.&quot;</span>
  <span class='end end kw'>end</span>
  <span class='return return kw'>return</span> <span class='pkg identifier id'>pkg</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="indent-instance_method">
  
    - (<tt>Object</tt>) <strong>indent</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


93
94
95</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 93</span>

<span class='def def kw'>def</span> <span class='indent identifier id'>indent</span>
  <span class='string val'>' '</span>  <span class='mult op'>*</span> <span class='integer val'>4</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="missing_issues-instance_method">
  
    - (<tt>Object</tt>) <strong>missing_issues</strong>(url, pool_data_array) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


97
98
99
100
101
102
103
104</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 97</span>

<span class='def def kw'>def</span> <span class='missing_issues identifier id'>missing_issues</span> <span class='url identifier id'>url</span><span class='comma token'>,</span> <span class='pool_data_array identifier id'>pool_data_array</span>
  <span class='messages identifier id'>messages</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='pool_data_array identifier id'>pool_data_array</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='push identifier id'>push</span><span class='lparen token'>(</span><span class='indent identifier id'>indent</span> <span class='plus op'>+</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='location identifier id'>location</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='status identifier id'>status</span> <span class='eq op'>==</span> <span class='string val'>&quot;missing&quot;</span> <span class='rbrace token'>}</span>

  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
  <span class='return return kw'>return</span> <span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='unshift identifier id'>unshift</span> <span class='dstring node'>&quot;#{url} missing #{messages.length} #{messages.length == 1 ? 'copy' : 'copies'}:&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="pluralize-instance_method">
  
    - (<tt>Object</tt>) <strong>pluralize</strong>(count, singular, plural) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


126
127
128
129</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 126</span>

<span class='def def kw'>def</span> <span class='pluralize identifier id'>pluralize</span> <span class='count identifier id'>count</span><span class='comma token'>,</span> <span class='singular identifier id'>singular</span><span class='comma token'>,</span> <span class='plural identifier id'>plural</span>
  <span class='return return kw'>return</span> <span class='singular identifier id'>singular</span> <span class='if if_mod kw'>if</span> <span class='count identifier id'>count</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
  <span class='return return kw'>return</span> <span class='plural identifier id'>plural</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="run-instance_method">
  
    - (<tt>Object</tt>) <strong>run</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store-master/fixity/analyzer.rb', line 144</span>

<span class='def def kw'>def</span> <span class='run identifier id'>run</span>
  <span class='counter identifier id'>counter</span> <span class='assign token'>=</span> <span class='StatCounter constant id'>StatCounter</span><span class='dot token'>.</span><span class='new identifier id'>new</span>

  <span class='lparen token'>(</span><span class='@pool_fixity_stream ivar id'>@pool_fixity_stream</span> <span class='cmp op'>&lt;=&gt;</span> <span class='@daitss_fixity_stream ivar id'>@daitss_fixity_stream</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='url identifier id'>url</span><span class='comma token'>,</span> <span class='pool_data identifier id'>pool_data</span><span class='comma token'>,</span> <span class='daitss_data identifier id'>daitss_data</span><span class='bitor op'>|</span>

    <span class='comment val'># for example</span>
    <span class='comment val'>#</span>
    <span class='comment val'># url:          http://store-master.fcla.edu/packages/EYMZSFV43_8A2KCD.000</span>
    <span class='comment val'># pool_data:    [ #&lt;struct Struct::PoolFixityRecord location=&quot;http...&quot;, sha1=&quot;4ab..&quot;, md5=&quot;0d7...&quot;, size=&quot;131..&quot;, fixity_time=&quot;2011-04-27T11:38:30Z&quot;, put_time=&quot;2011-04-20T20:21:33Z&quot;, status=&quot;ok&quot;&gt; .. more structs .. ]&gt;,</span>
    <span class='comment val'># daitss_data:  #&lt;struct ieid=&quot;E101W4TQQ_VGD9QW&quot;, url=&quot;http://storemaster.fda.fcla.edu:70/packages/E101W4TQQ_VGD9QW.000&quot;, last_successful_fixity_time=&quot;2011-10-02T03:38:38Z&quot;, package_store_time=&quot;2011-09-19T18:19:52Z&quot;, md5=&quot;f1b797725b64c4a06a81bcfac0c1f077&quot;, sha1=&quot;1a6f80fd868cda45e6f8413f8fc9dbd9c081f3f9&quot;, size=9256960&gt;</span>
            
    <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='pool_data identifier id'>pool_data</span>             <span class='comment val'># ..but we do have daitss_data for this URL, so we have a missing package of which the silo is unaware</span>

      <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='get_package identifier id'>get_package</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='rparen token'>)</span> <span class='comment val'># double check: is it still there in the DAITSS DB?  The deletion may have been in progress, and invisible, just as we started</span>

      <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_total identifier id'>packages_total</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
      <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_missing identifier id'>packages_missing</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
      <span class='@report_integrity ivar id'>@report_integrity</span><span class='dot token'>.</span><span class='err identifier id'>err</span>  <span class='dstring node'>&quot;#{url}: no copies where listed by any of the pools.&quot;</span>

      <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='integrity_failure_event identifier id'>integrity_failure_event</span><span class='lparen token'>(</span><span class='string val'>&quot;No copies were listed by any of the pools.&quot;</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_new identifier id'>events_new</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span> <span class='colon op'>:</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_err identifier id'>events_err</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
      
    <span class='elsif elsif kw'>elsif</span> <span class='not not kw'>not</span> <span class='daitss_data identifier id'>daitss_data</span>        <span class='comment val'># ..but we do have pool_data for this URL, so we may have some sort of 'orphan'.</span>

      <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='get_package identifier id'>get_package</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='rparen token'>)</span>   <span class='comment val'># double check: has it appeared in the DAITSS DB?  The store may have been in progress, and invisible, just as we started</span>

      <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_orphaned identifier id'>packages_orphaned</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
      <span class='@report_orphaned ivar id'>@report_orphaned</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='mult op'>*</span><span class='lparen token'>(</span><span class='pool_data identifier id'>pool_data</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='cp identifier id'>cp</span><span class='bitor op'>|</span> <span class='cp identifier id'>cp</span><span class='dot token'>.</span><span class='location identifier id'>location</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span>

    <span class='else else kw'>else</span>                         <span class='comment val'># .. we have records for both</span>

      <span class='all_good identifier id'>all_good</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>

      <span class='case case kw'>case</span>             
      <span class='when when kw'>when</span> <span class='pool_data identifier id'>pool_data</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='lt op'>&lt;</span> <span class='@required_copies ivar id'>@required_copies</span>

        <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='get_package identifier id'>get_package</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='rparen token'>)</span>

        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_total identifier id'>packages_total</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_missing identifier id'>packages_missing</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>

        <span class='messages identifier id'>messages</span> <span class='assign token'>=</span>  <span class='lbrack token'>[</span> <span class='dstring node'>&quot;#{url} has too few copies, only:&quot;</span> <span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='pool_data identifier id'>pool_data</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='indent identifier id'>indent</span> <span class='plus op'>+</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='location identifier id'>location</span> <span class='rbrace token'>}</span>

        <span class='@report_integrity ivar id'>@report_integrity</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='mult op'>*</span><span class='messages identifier id'>messages</span>
        
        <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='integrity_failure_event identifier id'>integrity_failure_event</span><span class='lparen token'>(</span><span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_new identifier id'>events_new</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span> <span class='colon op'>:</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_err identifier id'>events_err</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='all_good identifier id'>all_good</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>

      <span class='when when kw'>when</span> <span class='pool_data identifier id'>pool_data</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='gt op'>&gt;</span> <span class='@required_copies ivar id'>@required_copies</span>

        <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='get_package identifier id'>get_package</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='rparen token'>)</span>

        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_total identifier id'>packages_total</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_wrong_number identifier id'>packages_wrong_number</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>

        <span class='messages identifier id'>messages</span> <span class='assign token'>=</span>  <span class='lbrack token'>[</span> <span class='dstring node'>&quot;#{url} has too many copies:&quot;</span> <span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='pool_data identifier id'>pool_data</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='indent identifier id'>indent</span> <span class='plus op'>+</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='location identifier id'>location</span> <span class='rbrace token'>}</span>

        <span class='@report_too_many ivar id'>@report_too_many</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='mult op'>*</span><span class='messages identifier id'>messages</span>

        <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='integrity_failure_event identifier id'>integrity_failure_event</span><span class='lparen token'>(</span><span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_new identifier id'>events_new</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span> <span class='colon op'>:</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_err identifier id'>events_err</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>

        <span class='all_good identifier id'>all_good</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># Pools may sometimes be aware of missing packages and directly report them:</span>

      <span class='missing_issue_messages identifier id'>missing_issue_messages</span> <span class='assign token'>=</span> <span class='missing_issues identifier id'>missing_issues</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='comma token'>,</span> <span class='pool_data identifier id'>pool_data</span><span class='rparen token'>)</span>

      <span class='comment val'># Compare fixities:</span>

      <span class='fixity_issue_messages identifier id'>fixity_issue_messages</span>  <span class='assign token'>=</span> <span class='fixity_issues identifier id'>fixity_issues</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='comma token'>,</span> <span class='pool_data identifier id'>pool_data</span><span class='comma token'>,</span> <span class='daitss_data identifier id'>daitss_data</span><span class='rparen token'>)</span> 

      <span class='if if kw'>if</span> <span class='fixity_issue_messages identifier id'>fixity_issue_messages</span>
        
        <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='get_package identifier id'>get_package</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='rparen token'>)</span>

        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_fixity_failure identifier id'>packages_fixity_failure</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>

        <span class='@report_fixity ivar id'>@report_fixity</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='mult op'>*</span><span class='lparen token'>(</span><span class='fixity_issue_messages identifier id'>fixity_issue_messages</span> <span class='plus op'>+</span> <span class='lbrack token'>[</span> <span class='string val'>''</span> <span class='rbrack token'>]</span><span class='rparen token'>)</span>

        <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='fixity_failure_event identifier id'>fixity_failure_event</span><span class='lparen token'>(</span><span class='fixity_issue_messages identifier id'>fixity_issue_messages</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_new identifier id'>events_new</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span> <span class='colon op'>:</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_err identifier id'>events_err</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>

        <span class='all_good identifier id'>all_good</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
      <span class='end end kw'>end</span>

      <span class='if if kw'>if</span> <span class='missing_issue_messages identifier id'>missing_issue_messages</span>

        <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='get_package identifier id'>get_package</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='rparen token'>)</span>

        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_missing identifier id'>packages_missing</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>

        <span class='@report_integrity ivar id'>@report_integrity</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='mult op'>*</span><span class='lparen token'>(</span><span class='missing_issue_messages identifier id'>missing_issue_messages</span> <span class='plus op'>+</span> <span class='lbrack token'>[</span> <span class='string val'>''</span> <span class='rbrack token'>]</span><span class='rparen token'>)</span>

        <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='integrity_failure_event identifier id'>integrity_failure_event</span><span class='lparen token'>(</span><span class='missing_issue_messages identifier id'>missing_issue_messages</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_new identifier id'>events_new</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span> <span class='colon op'>:</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_err identifier id'>events_err</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>

        <span class='all_good identifier id'>all_good</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># we're using counter to keep track of the total number of packages; in the following</span>
      <span class='comment val'># very unlikely case we'd be double counting, so let's flag it and display a note when reporting.</span>

      <span class='if if kw'>if</span> <span class='missing_issue_messages identifier id'>missing_issue_messages</span> <span class='and and kw'>and</span> <span class='fixity_issue_messages identifier id'>fixity_issue_messages</span>
        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_double_counted identifier id'>packages_double_counted</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
      <span class='end end kw'>end</span>

      <span class='if if kw'>if</span> <span class='all_good identifier id'>all_good</span>

        <span class='pool_fixity_time identifier id'>pool_fixity_time</span>   <span class='assign token'>=</span> <span class='pool_data identifier id'>pool_data</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='fixity_time identifier id'>fixity_time</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='min identifier id'>min</span>
        <span class='daitss_fixity_time identifier id'>daitss_fixity_time</span> <span class='assign token'>=</span> <span class='daitss_data identifier id'>daitss_data</span><span class='dot token'>.</span><span class='last_successful_fixity_time identifier id'>last_successful_fixity_time</span>

        <span class='comment val'># count success if we've got a match</span>

        <span class='if if kw'>if</span> <span class='pool_fixity_time identifier id'>pool_fixity_time</span> <span class='eq op'>==</span> <span class='daitss_fixity_time identifier id'>daitss_fixity_time</span>
          <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_fixity_unchanged identifier id'>packages_fixity_unchanged</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
          <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_old identifier id'>events_old</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
          <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_total identifier id'>packages_total</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
          <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_checked identifier id'>packages_checked</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
          <span class='next next kw'>next</span>
        <span class='end end kw'>end</span>

        <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='get_package identifier id'>get_package</span><span class='lparen token'>(</span><span class='url identifier id'>url</span><span class='rparen token'>)</span>

        <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='fixity_success_event identifier id'>fixity_success_event</span><span class='lparen token'>(</span><span class='pool_fixity_time identifier id'>pool_fixity_time</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_new identifier id'>events_new</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span> <span class='colon op'>:</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_err identifier id'>events_err</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_fixity_success identifier id'>packages_fixity_success</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_total identifier id'>packages_total</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_checked identifier id'>packages_checked</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='expiration_date identifier id'>expiration_date</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='DateTime constant id'>DateTime</span><span class='dot token'>.</span><span class='now identifier id'>now</span> <span class='minus op'>-</span> <span class='@expiration_days ivar id'>@expiration_days</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>

  <span class='@pool_fixity_stream ivar id'>@pool_fixity_stream</span><span class='dot token'>.</span><span class='rewind identifier id'>rewind</span>
  <span class='@daitss_fixity_stream ivar id'>@daitss_fixity_stream</span><span class='dot token'>.</span><span class='rewind identifier id'>rewind</span>

  <span class='lparen token'>(</span><span class='@pool_fixity_stream ivar id'>@pool_fixity_stream</span> <span class='cmp op'>&lt;=&gt;</span> <span class='@daitss_fixity_stream ivar id'>@daitss_fixity_stream</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='url identifier id'>url</span><span class='comma token'>,</span> <span class='pool_data identifier id'>pool_data</span><span class='comma token'>,</span> <span class='daitss_data identifier id'>daitss_data</span><span class='bitor op'>|</span>

    <span class='next next kw'>next</span> <span class='unless unless_mod kw'>unless</span> <span class='daitss_data identifier id'>daitss_data</span> <span class='and and kw'>and</span> <span class='pool_data identifier id'>pool_data</span>   <span class='comment val'># we skip reporting expired orphans</span>

    <span class='pool_data identifier id'>pool_data</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='fix identifier id'>fix</span><span class='bitor op'>|</span>
      <span class='if if kw'>if</span> <span class='fix identifier id'>fix</span><span class='dot token'>.</span><span class='fixity_time identifier id'>fixity_time</span> <span class='lt op'>&lt;</span> <span class='expiration_date identifier id'>expiration_date</span>
        <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_expired identifier id'>packages_expired</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='@report_expired ivar id'>@report_expired</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='fix identifier id'>fix</span><span class='dot token'>.</span><span class='location identifier id'>location</span> <span class='plus op'>+</span> <span class='string val'>&quot; last checked at &quot;</span> <span class='plus op'>+</span> <span class='fix identifier id'>fix</span><span class='dot token'>.</span><span class='fixity_time identifier id'>fixity_time</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

  <span class='end end kw'>end</span>

  <span class='comment val'># We are looking for a report that looks roughly like the following: </span>
  <span class='comment val'>#</span>
  <span class='comment val'># Summary of DAITSS Package Fixity Checks</span>
  <span class='comment val'># :::::::::::::::::::::::::::::::::::::::</span>
  <span class='comment val'>#</span>
  <span class='comment val'># 1,242 ingested package records as of 2011-12-01 04:15:00</span>
  <span class='comment val'># 1,242 ingested package records were checked against fixity data.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># 1,240 correct fixities</span>
  <span class='comment val'>#     1 incorrect fixity</span>
  <span class='comment val'>#     2 missing packages</span>
  <span class='comment val'>#     0 packages with wrong number of copies in pools</span>
  <span class='comment val'># -----</span>
  <span class='comment val'># 1,242 events, 3 new</span>
  <span class='comment val'>#</span>
  <span class='comment val'># Additionally:</span>
  <span class='comment val'>#</span>
  <span class='comment val'>#     1 package had an expired fixity</span>
  <span class='comment val'>#     1 unexpected package (orphan?) in silo pools</span>
  <span class='comment val'>#</span>

  <span class='comment val'># ...</span>
  
  <span class='width identifier id'>width</span> <span class='assign token'>=</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='format_max_width identifier id'>format_max_width</span>

  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s ingested package records as of %s&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_total identifier id'>packages_total</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='@cutoff_time ivar id'>@cutoff_time</span><span class='dot token'>.</span><span class='strftime identifier id'>strftime</span><span class='lparen token'>(</span><span class='string val'>'%F %T'</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s of these records were checked against fixity data&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_checked identifier id'>packages_checked</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s correct #{pluralize counter.packages_fixity_success, 'fixity', 'fixities'}&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_fixity_success identifier id'>packages_fixity_success</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s had missing copies&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_missing identifier id'>packages_missing</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s incorrect #{pluralize counter.packages_fixity_failure, 'fixity', 'fixities'}&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_fixity_failure identifier id'>packages_fixity_failure</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s with the wrong number of copies in pools&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_wrong_number identifier id'>packages_wrong_number</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='string val'>'-'</span> <span class='mult op'>*</span> <span class='width identifier id'>width</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s total events, %s new&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_total identifier id'>events_total</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_total identifier id'>events_total</span> <span class='minus op'>-</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_old identifier id'>events_old</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='string val'>'Additionally:'</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s unexpected package#{pluralize counter.packages_orphaned, '', 's'} (orphan?) in silo pools&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_orphaned identifier id'>packages_orphaned</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='sprintf identifier id'>sprintf</span><span class='lparen token'>(</span><span class='dstring node'>&quot;%#{width}s package#{pluralize counter.packages_expired, '', 's'} had #{pluralize counter.packages_expired, 'an expired fixity', 'expired fixities'}&quot;</span><span class='comma token'>,</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span><span class='lparen token'>(</span><span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_expired identifier id'>packages_expired</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

  <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='n identifier id'>n</span> <span class='assign token'>=</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='events_err identifier id'>events_err</span><span class='rparen token'>)</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>      
    <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='err identifier id'>err</span> <span class='dstring node'>&quot;There #{n == 1 ? 'was one failure' : sprintf('were %d failures', n) } writing to the DAITSS DB&quot;</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='n identifier id'>n</span> <span class='assign token'>=</span> <span class='counter identifier id'>counter</span><span class='dot token'>.</span><span class='packages_double_counted identifier id'>packages_double_counted</span><span class='rparen token'>)</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
    <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='string val'>&quot;Note that there were multiple events recorded for some packages (this can&quot;</span>
    <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='string val'>&quot;happen when a package has a copy failing a fixity check, with the other missing).&quot;</span>
    <span class='if if kw'>if</span> <span class='n identifier id'>n</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
      <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='string val'>&quot;There was one such double count.&quot;</span>
    <span class='else else kw'>else</span>
      <span class='@report_summary ivar id'>@report_summary</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='dstring node'>&quot;There were #{n} such double counts.&quot;</span>
    <span class='end end kw'>end</span>      
  <span class='end end kw'>end</span>

  <span class='comment val'># Note that this run method returns self, which has all of the</span>
  <span class='comment val'># reports on it; while the reports info/warn/err messages have</span>
  <span class='comment val'># already been sent to the log, the calling program may very</span>
  <span class='comment val'># well write all of them, in the order the reports were stored</span>
  <span class='comment val'># on @reports above - @report_summary is first.</span>

  <span class='self self kw'>self</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Mon Oct 31 10:37:59 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.2 (ruby-1.8.7).
</div>

  </body>
</html>