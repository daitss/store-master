<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: StorageMasterModel::Package
  
    &mdash; Storage Master Service
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (P)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../StorageMasterModel.html" title="StorageMasterModel (module)">StorageMasterModel</a></span></span>
     &raquo; 
    <span class="title">Package</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: StorageMasterModel::Package
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">StorageMasterModel::Package</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">DataMapper::Resource, <span class='object_link'><a href="../StorageMaster.html" title="StorageMaster (module)">StorageMaster</a></span></dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb<span class="defines">,<br />
  /Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/fixity/store-package-stream.rb</span>
</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>The StorageMasterModel::Package class keeps track of what packages we’ve
successfully received and stored to one or more Silo Pools.</p>

<pre class="code"><span class='It constant id'>It</span> <span class='requires identifier id'>requires</span> <span class='a identifier id'>a</span> <span class='class class kw'>class</span> <span class='member identifier id'>member</span> <span class='to identifier id'>to</span> <span class='be identifier id'>be</span> <span class='initialized identifier id'>initialized</span> <span class='before identifier id'>before</span> <span class='use identifier id'>use</span><span class='comma token'>,</span> <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='g identifier id'>g</span><span class='dot token'>.</span>

  <span class='StorageMasterModel constant id'>StorageMasterModel</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='server_location identifier id'>server_location</span> <span class='assign token'>=</span> <span class='string val'>'https://storage-master.fda.fcla.edu:70'</span>  

<span class='The constant id'>The</span> <span class='class class kw'>class</span> <span class='method identifier id'>method</span> <span class='store identifier id'>store</span> <span class='can identifier id'>can</span> <span class='then then kw'>then</span> <span class='be identifier id'>be</span> <span class='used identifier id'>used</span> <span class='to identifier id'>to</span> <span class='construct identifier id'>construct</span> <span class='a identifier id'>a</span> <span class='package identifier id'>package</span><span class='colon op'>:</span>

  <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='StorageMasterModel constant id'>StorageMasterModel</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='store identifier id'>store</span><span class='lparen token'>(</span><span class='IO constant id'>IO</span><span class='comma token'>,</span> <span class='metadata identifier id'>metadata</span><span class='comma token'>,</span> <span class='lbrack token'>[</span> <span class='silo_one identifier id'>silo_one</span><span class='comma token'>,</span> <span class='silo_two identifier id'>silo_two</span> <span class='rbrack token'>]</span><span class='rparen token'>)</span>

<span class='The constant id'>The</span> <span class='class class kw'>class</span> <span class='method identifier id'>method</span> <span class='lookup identifier id'>lookup</span> <span class='can identifier id'>can</span> <span class='be identifier id'>be</span> <span class='used identifier id'>used</span> <span class='to identifier id'>to</span> <span class='find identifier id'>find</span> <span class='an identifier id'>an</span> <span class='extant identifier id'>extant</span> <span class='package identifier id'>package</span><span class='colon op'>:</span>

  <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='StorageMasterModel constant id'>StorageMasterModel</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='store identifier id'>store</span><span class='lparen token'>(</span><span class='string val'>'E20111201_AAAAZR'</span><span class='rparen token'>)</span>
</pre>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="server_location-classvariable" class="">@@server_location =
          <div class="docstring">
  <div class="discussion">
    
<p>the location of the Storage Master service, e.g. <a
href="http://storage-master.example.com:8080">storage-master.example.com:8080</a></p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='nil nil kw'>nil</span>
</pre></dd>
      
    </dl>
  


  
  
  
  
  <h3 class="inherited">Constants included from <span class='object_link'><a href="../StorageMaster.html" title="StorageMaster (module)">StorageMaster</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../StorageMaster.html#NAME-constant" title="StorageMaster::NAME (constant)">NAME</a></span>, <span class='object_link'><a href="../StorageMaster.html#RELEASE-constant" title="StorageMaster::RELEASE (constant)">RELEASE</a></span>, <span class='object_link'><a href="../StorageMaster.html#REVISION-constant" title="StorageMaster::REVISION (constant)">REVISION</a></span>, <span class='object_link'><a href="../StorageMaster.html#VERSION-constant" title="StorageMaster::VERSION (constant)">VERSION</a></span></p>

  
  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#etag-instance_method" title="#etag (instance method)">- (Object) <strong>etag</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>scratch pad attributes filled in on succesful store.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#md5-instance_method" title="#md5 (instance method)">- (Object) <strong>md5</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>scratch pad attributes filled in on succesful store.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#sha1-instance_method" title="#sha1 (instance method)">- (Object) <strong>sha1</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>scratch pad attributes filled in on succesful store.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#size-instance_method" title="#size (instance method)">- (Object) <strong>size</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>scratch pad attributes filled in on succesful store.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#type-instance_method" title="#type (instance method)">- (Object) <strong>type</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>scratch pad attributes filled in on succesful store.</p>
</div></span>
  
</li>

    
  </ul>



  
  
  
  

  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#exists%3F-class_method" title="exists? (class method)">+ (Boolean) <strong>exists?</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Package.exists? tells us if the package stored with name still exists.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#list-class_method" title="list (class method)">+ (Object) <strong>list</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Package.list yields all of the package objects, one at a time.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lookup-class_method" title="lookup (class method)">+ (StorageMasterModel::Package) <strong>lookup</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Package.was_deleted? tells us if a package was created and subsequently
deleted.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#package_chunks-class_method" title="package_chunks (class method)">+ (Object) <strong>package_chunks</strong> </a>
    

    
  </span>
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>package_chunks lets us effciently trundle through all of the packages - we
have hundreds of thousands of them.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#package_copies-class_method" title="package_copies (class method)">+ (Object) <strong>package_copies</strong>(before = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search-class_method" title="search (class method)">+ (Array) <strong>search</strong>(name, limit = 1) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Package.search returns a list of packages objects matching a search string.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#server_location-class_method" title="server_location (class method)">+ (Object) <strong>server_location</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#server_location%3D-class_method" title="server_location= (class method)">+ (Object) <strong>server_location=</strong>(prefix) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#store-class_method" title="store (class method)">+ (StoreMasterModel::Package) <strong>store</strong>(io, metadata, pools) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Package.store sends a data stream to multiple silo pools and returns a new
package object.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stub-class_method" title="stub (class method)">+ (Object) <strong>stub</strong>(io, metadata) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Package.stub is like a /dev/null version of Package.store.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#was_deleted%3F-class_method" title="was_deleted? (class method)">+ (Boolean) <strong>was_deleted?</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Package.was_deleted? tells us if a package was created and subsequently
deleted.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete-instance_method" title="#delete (instance method)">- (Object) <strong>delete</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>delete attempts to remove all copies of a package and mark it as deleted.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#locations-instance_method" title="#locations (instance method)">- (ARRAY) <strong>locations</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the locations of outr package.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#url-instance_method" title="#url (instance method)">- (Object) <strong>url</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return a string that gives the Stoage Master’s location of this package.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../StorageMaster.html" title="StorageMaster (module)">StorageMaster</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../StorageMaster.html#setup_databases-class_method" title="StorageMaster.setup_databases (method)">setup_databases</a></span>, <span class='object_link'><a href="../StorageMaster.html#version-class_method" title="StorageMaster.version (method)">version</a></span></p>

  
  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="etag=-instance_method"></span>
      <span id="etag-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="etag-instance_method">
  
    - (<tt>Object</tt>) <strong>etag</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>scratch pad attributes filled in on succesful store</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 42</span>

<span class='def def kw'>def</span> <span class='etag identifier id'>etag</span>
  <span class='@etag ivar id'>@etag</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="md5=-instance_method"></span>
      <span id="md5-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="md5-instance_method">
  
    - (<tt>Object</tt>) <strong>md5</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>scratch pad attributes filled in on succesful store</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 42</span>

<span class='def def kw'>def</span> <span class='md5 identifier id'>md5</span>
  <span class='@md5 ivar id'>@md5</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="sha1=-instance_method"></span>
      <span id="sha1-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="sha1-instance_method">
  
    - (<tt>Object</tt>) <strong>sha1</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>scratch pad attributes filled in on succesful store</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 42</span>

<span class='def def kw'>def</span> <span class='sha1 identifier id'>sha1</span>
  <span class='@sha1 ivar id'>@sha1</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="size=-instance_method"></span>
      <span id="size-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="size-instance_method">
  
    - (<tt>Object</tt>) <strong>size</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>scratch pad attributes filled in on succesful store</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 42</span>

<span class='def def kw'>def</span> <span class='size identifier id'>size</span>
  <span class='@size ivar id'>@size</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="type=-instance_method"></span>
      <span id="type-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="type-instance_method">
  
    - (<tt>Object</tt>) <strong>type</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>scratch pad attributes filled in on succesful store</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 42</span>

<span class='def def kw'>def</span> <span class='type identifier id'>type</span>
  <span class='@type ivar id'>@type</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="exists?-class_method">
  
    + (<tt>Boolean</tt>) <strong>exists?</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Package.exists? tells us if the package stored with name still exists.  It
is not safe to use the name for a package creation, since it may have been
created and deleted, and we never allow a name to be reused.</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>name,</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the name of the package, e.g. E20111201_AAAAZR</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


78
79
80</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 78</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='name identifier id'>name</span>
  <span class='not not kw'>not</span> <span class='first identifier id'>first</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="list-class_method">
  
    + (<tt>Object</tt>) <strong>list</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Package.list yields all of the package objects, one at a time.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


127
128
129
130
131
132
133
134
135</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 127</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='list identifier id'>list</span>
  <span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='transaction identifier id'>transaction</span> <span class='do do kw'>do</span>              <span class='comment val'># isolation, we don't want updates/deletes to throw package_chunks off.</span>
    <span class='package_chunks identifier id'>package_chunks</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='records identifier id'>records</span><span class='bitor op'>|</span>
      <span class='records identifier id'>records</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span>
        <span class='yield yield kw'>yield</span> <span class='rec identifier id'>rec</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="lookup-class_method">
  
    + (<tt><span class='object_link'><a href="" title="StorageMasterModel::Package (class)">StorageMasterModel::Package</a></span></tt>) <strong>lookup</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Package.was_deleted? tells us if a package was created and subsequently
deleted.</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>name,</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the name of the package, e.g. E20111201_AAAAZR</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="StorageMasterModel::Package (class)">StorageMasterModel::Package</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the package object, if it still exists</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


95
96
97</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 95</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='lookup identifier id'>lookup</span> <span class='name identifier id'>name</span>
  <span class='first identifier id'>first</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="package_chunks-class_method">
  
    + (<tt>Object</tt>) <strong>package_chunks</strong>  <span class="extras">(private)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>package_chunks lets us effciently trundle through all of the packages - we
have hundreds of thousands of them.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


115
116
117
118
119
120
121</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 115</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='package_chunks identifier id'>package_chunks</span>
  <span class='offset identifier id'>offset</span> <span class='assign token'>=</span> <span class='integer val'>0</span>
  <span class='while while kw'>while</span> <span class='not not kw'>not</span> <span class='lparen token'>(</span><span class='packages identifier id'>packages</span>  <span class='assign token'>=</span> <span class='all identifier id'>all</span><span class='lparen token'>(</span><span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span> <span class='symbol val'>:name</span><span class='dot token'>.</span><span class='asc identifier id'>asc</span> <span class='rbrack token'>]</span> <span class='rparen token'>)</span><span class='dot token'>.</span><span class='slice identifier id'>slice</span><span class='lparen token'>(</span><span class='offset identifier id'>offset</span><span class='comma token'>,</span> <span class='integer val'>2000</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    <span class='offset identifier id'>offset</span> <span class='opasgn op'>+=</span> <span class='packages identifier id'>packages</span><span class='dot token'>.</span><span class='length identifier id'>length</span>
    <span class='yield yield kw'>yield</span> <span class='packages identifier id'>packages</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="package_copies-class_method">
  
    + (<tt>Object</tt>) <strong>package_copies</strong>(before = nil) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35
36
37
38
39
40
41
42</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/fixity/store-package-stream.rb', line 33</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='package_copies identifier id'>package_copies</span>  <span class='before identifier id'>before</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='before identifier id'>before</span> <span class='opasgn op'>||=</span> <span class='DateTime constant id'>DateTime</span><span class='dot token'>.</span><span class='now identifier id'>now</span>
  <span class='sql identifier id'>sql</span> <span class='assign token'>=</span> <span class='string val'>&quot;SELECT packages.name, copies.store_location, packages.ieid &quot;</span> <span class='plus op'>+</span>
          <span class='string val'>&quot;FROM packages, copies &quot;</span>                                    <span class='plus op'>+</span>
         <span class='string val'>&quot;WHERE packages.id = copies.package_id &quot;</span>                     <span class='plus op'>+</span>
           <span class='dstring node'>&quot;AND copies.datetime &lt; '#{before}' &quot;</span>                       <span class='plus op'>+</span>
      <span class='string val'>&quot;ORDER BY packages.name&quot;</span>

  <span class='repository identifier id'>repository</span><span class='lparen token'>(</span><span class='symbol val'>:default</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='adapter identifier id'>adapter</span><span class='dot token'>.</span><span class='select identifier id'>select</span><span class='lparen token'>(</span><span class='sql identifier id'>sql</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="search-class_method">
  
    + (<tt>Array</tt>) <strong>search</strong>(name, limit = 1) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Package.search returns a list of packages objects matching a search string.</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>name,</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the partial name of the packages to search for, e.g. ‘E2011’</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>limit,</span>
      
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>optionally, the number of packages to return, defaults to 1</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>a list of the package objects, ordered alphabetically by name</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


106
107
108</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 106</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='search identifier id'>search</span> <span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='limit identifier id'>limit</span> <span class='assign token'>=</span> <span class='integer val'>1</span>
  <span class='first identifier id'>first</span><span class='lparen token'>(</span><span class='limit identifier id'>limit</span><span class='comma token'>,</span> <span class='symbol val'>:name</span><span class='dot token'>.</span><span class='like identifier id'>like</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;%#{name}%&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='dot token'>.</span><span class='asc identifier id'>asc</span> <span class='rbrack token'>]</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="server_location-class_method">
  
    + (<tt>Object</tt>) <strong>server_location</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


50
51
52</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 50</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='server_location identifier id'>server_location</span>
  <span class='@@server_location ivar id'>@@server_location</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="server_location=-class_method">
  
    + (<tt>Object</tt>) <strong>server_location=</strong>(prefix) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


46
47
48</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 46</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='server_location identifier id'>server_location</span><span class='assign token'>=</span> <span class='prefix identifier id'>prefix</span>
  <span class='@@server_location ivar id'>@@server_location</span> <span class='assign token'>=</span> <span class='prefix identifier id'>prefix</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/:80$/</span><span class='comma token'>,</span> <span class='string val'>''</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="store-class_method">
  
    + (<tt>StoreMasterModel::Package</tt>) <strong>store</strong>(io, metadata, pools) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Package.store sends a data stream to multiple silo pools and returns a new
package object. In the case of error we clean up as best we can.</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>io,</span>
      
      
        <span class='type'>(<tt>IO</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the package contents (usually an opened tarfile)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>metadata,</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>metadata for the package contents, including the name, size and md5
checksum of the package</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>pools,</span>
      
      
        <span class='type'>(<tt>ARRAY</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>a list of Pool objects to which we will store the package</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>StoreMasterModel::Package</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the created package on success</p>
</div>
      
    </li>
  
</ul>
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../StorageMaster/SiloStoreError.html" title="StorageMaster::SiloStoreError (class)">SiloStoreError</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 147</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='store identifier id'>store</span> <span class='io identifier id'>io</span><span class='comma token'>,</span> <span class='metadata identifier id'>metadata</span><span class='comma token'>,</span> <span class='pools identifier id'>pools</span>
  <span class='copies identifier id'>copies</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='required_metadata identifier id'>required_metadata</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span> <span class='symbol val'>:name</span><span class='comma token'>,</span> <span class='symbol val'>:ieid</span><span class='comma token'>,</span> <span class='symbol val'>:md5</span><span class='comma token'>,</span> <span class='symbol val'>:size</span><span class='comma token'>,</span> <span class='symbol val'>:type</span> <span class='rbrack token'>]</span>
  <span class='missing_metadata identifier id'>missing_metadata</span>  <span class='assign token'>=</span> <span class='required_metadata identifier id'>required_metadata</span> <span class='minus op'>-</span> <span class='lparen token'>(</span><span class='required_metadata identifier id'>required_metadata</span> <span class='bitand op'>&amp;</span> <span class='metadata identifier id'>metadata</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='rparen token'>)</span>

  <span class='raise identifier id'>raise</span> <span class='SiloStoreError constant id'>SiloStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't store data package, missing information for #{missing_metadata.join(', ')}&quot;</span>         <span class='unless unless_mod kw'>unless</span> <span class='missing_metadata identifier id'>missing_metadata</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>

  <span class='raise identifier id'>raise</span> <span class='PackageUsed constant id'>PackageUsed</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't store package #{metadata[:name]}, it already exists&quot;</span>                                    <span class='if if_mod kw'>if</span> <span class='exists? fid id'>exists?</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>
  <span class='raise identifier id'>raise</span> <span class='PackageUsed constant id'>PackageUsed</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't store package using name #{metadata[:name]}, it's been previously created and deleted&quot;</span>  <span class='if if_mod kw'>if</span> <span class='was_deleted? fid id'>was_deleted?</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>

  <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:ieid</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:ieid</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:md5</span><span class='rbrack token'>]</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='assign token'>=</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:size</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='type identifier id'>type</span> <span class='assign token'>=</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span>

  <span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='transaction identifier id'>transaction</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='trans identifier id'>trans</span><span class='bitor op'>|</span>
    <span class='begin begin kw'>begin</span>
      <span class='pools identifier id'>pools</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='pool identifier id'>pool</span><span class='bitor op'>|</span>
        <span class='cpy identifier id'>cpy</span> <span class='assign token'>=</span> <span class='Copy constant id'>Copy</span><span class='dot token'>.</span><span class='store identifier id'>store</span><span class='lparen token'>(</span><span class='io identifier id'>io</span><span class='comma token'>,</span> <span class='pkg identifier id'>pkg</span><span class='comma token'>,</span> <span class='pool identifier id'>pool</span><span class='rparen token'>)</span>
        <span class='copies identifier id'>copies</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='cpy identifier id'>cpy</span>

        <span class='msg identifier id'>msg</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;Error copying package #{pkg.name} to #{cpy.store_location}:&quot;</span>

        <span class='raise identifier id'>raise</span> <span class='SiloStoreError constant id'>SiloStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{msg} md5 mismatch (we have #{pkg.md5}, got back #{cpy.md5})&quot;</span>         <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='md5 identifier id'>md5</span>  <span class='eq op'>==</span> <span class='cpy identifier id'>cpy</span><span class='dot token'>.</span><span class='md5 identifier id'>md5</span>
        <span class='raise identifier id'>raise</span> <span class='SiloStoreError constant id'>SiloStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{msg} size mismatch (we have #{pkg.size}, got back #{cpy.size})&quot;</span>      <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='eq op'>==</span> <span class='cpy identifier id'>cpy</span><span class='dot token'>.</span><span class='size identifier id'>size</span>
        <span class='raise identifier id'>raise</span> <span class='SiloStoreError constant id'>SiloStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{msg} mime-type mismatch (we have #{pkg.type}, got back #{cpy.type})&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='type identifier id'>type</span> <span class='eq op'>==</span> <span class='cpy identifier id'>cpy</span><span class='dot token'>.</span><span class='type identifier id'>type</span>

        <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='sha1 identifier id'>sha1</span> <span class='assign token'>=</span> <span class='cpy identifier id'>cpy</span><span class='dot token'>.</span><span class='sha1 identifier id'>sha1</span>
      <span class='end end kw'>end</span>

      <span class='copies identifier id'>copies</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='cp identifier id'>cp</span><span class='bitor op'>|</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='copies identifier id'>copies</span> <span class='lshft op'>&lt;&lt;</span> <span class='cp identifier id'>cp</span> <span class='rbrace token'>}</span>

      <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='save identifier id'>save</span>
        <span class='errors identifier id'>errors</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
        <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='full_messages identifier id'>full_messages</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>', '</span><span class='rparen token'>)</span>
        <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='copies identifier id'>copies</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='cp identifier id'>cp</span><span class='bitor op'>|</span>  <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='push identifier id'>push</span>  <span class='cp identifier id'>cp</span><span class='dot token'>.</span><span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='full_messages identifier id'>full_messages</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>', '</span><span class='rparen token'>)</span>  <span class='rbrace token'>}</span>
        <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Database error saving package #{pkg.name}: &quot;</span> <span class='plus op'>+</span> <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>'; '</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>

    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='trans identifier id'>trans</span><span class='dot token'>.</span><span class='rollback identifier id'>rollback</span>
      <span class='raise identifier id'>raise</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>


<span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='copies identifier id'>copies</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='cp identifier id'>cp</span><span class='bitor op'>|</span> <span class='cp identifier id'>cp</span><span class='dot token'>.</span><span class='quiet_delete identifier id'>quiet_delete</span> <span class='rbrace token'>}</span>
  <span class='raise identifier id'>raise</span>
<span class='else else kw'>else</span>
  <span class='pkg identifier id'>pkg</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="stub-class_method">
  
    + (<tt>Object</tt>) <strong>stub</strong>(io, metadata) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Package.stub is like a /dev/null version of Package.store. It is entirely
for test setups where we don’t want to create back-end silo pools.</p>


  </div>
</div>
<div class="tags">
  
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../StorageMaster/SiloStoreError.html" title="StorageMaster::SiloStoreError (class)">SiloStoreError</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 205</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='stub identifier id'>stub</span> <span class='io identifier id'>io</span><span class='comma token'>,</span> <span class='metadata identifier id'>metadata</span>
  <span class='required_metadata identifier id'>required_metadata</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span> <span class='symbol val'>:name</span><span class='comma token'>,</span> <span class='symbol val'>:ieid</span><span class='comma token'>,</span> <span class='symbol val'>:md5</span><span class='comma token'>,</span> <span class='symbol val'>:size</span><span class='comma token'>,</span> <span class='symbol val'>:type</span> <span class='rbrack token'>]</span>
  <span class='missing_metadata identifier id'>missing_metadata</span>  <span class='assign token'>=</span> <span class='required_metadata identifier id'>required_metadata</span> <span class='minus op'>-</span> <span class='lparen token'>(</span><span class='required_metadata identifier id'>required_metadata</span> <span class='bitand op'>&amp;</span> <span class='metadata identifier id'>metadata</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='rparen token'>)</span>

  <span class='raise identifier id'>raise</span> <span class='SiloStoreError constant id'>SiloStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't store data package, missing information for #{missing_metadata.join(', ')}&quot;</span>         <span class='unless unless_mod kw'>unless</span> <span class='missing_metadata identifier id'>missing_metadata</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>

  <span class='raise identifier id'>raise</span> <span class='PackageUsed constant id'>PackageUsed</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't store package #{metadata[:name]}, it already exists&quot;</span>                                    <span class='if if_mod kw'>if</span> <span class='exists? fid id'>exists?</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>
  <span class='raise identifier id'>raise</span> <span class='PackageUsed constant id'>PackageUsed</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't store package using name #{metadata[:name]}, it's been previously created and deleted&quot;</span>  <span class='if if_mod kw'>if</span> <span class='was_deleted? fid id'>was_deleted?</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>

  <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:ieid</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:ieid</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

  <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='rewind identifier id'>rewind</span> <span class='if if_mod kw'>if</span> <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='string val'>'rewind'</span><span class='rparen token'>)</span>
  <span class='sha1 identifier id'>sha1</span> <span class='assign token'>=</span> <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='SHA1 constant id'>SHA1</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span> <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='size identifier id'>size</span> <span class='assign token'>=</span> <span class='integer val'>0</span>
  <span class='while while kw'>while</span> <span class='buff identifier id'>buff</span> <span class='assign token'>=</span> <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='integer val'>1_048_576</span><span class='rparen token'>)</span>
    <span class='size identifier id'>size</span> <span class='opasgn op'>+=</span> <span class='buff identifier id'>buff</span><span class='dot token'>.</span><span class='length identifier id'>length</span>
    <span class='sha1 identifier id'>sha1</span> <span class='lshft op'>&lt;&lt;</span> <span class='buff identifier id'>buff</span>
    <span class='md5 identifier id'>md5</span>  <span class='lshft op'>&lt;&lt;</span> <span class='buff identifier id'>buff</span>
  <span class='end end kw'>end</span>

  <span class='msg identifier id'>msg</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;Error receiving package #{pkg.name} to stub service:&quot;</span>

  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='type identifier id'>type</span> <span class='assign token'>=</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span> <span class='md5 identifier id'>md5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='assign token'>=</span> <span class='size identifier id'>size</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='sha1 identifier id'>sha1</span> <span class='assign token'>=</span> <span class='sha1 identifier id'>sha1</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span>

  <span class='raise identifier id'>raise</span> <span class='SiloStoreError constant id'>SiloStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{msg} md5 mismatch (expected #{metadata[:md5]},  got #{pkg.md5})&quot;</span>      <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='md5 identifier id'>md5</span>  <span class='eq op'>==</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:md5</span><span class='rbrack token'>]</span>
  <span class='raise identifier id'>raise</span> <span class='SiloStoreError constant id'>SiloStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{msg} size mismatch (expected #{metadata[:size]}, got #{pkg.size})&quot;</span>    <span class='unless unless_mod kw'>unless</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='eq op'>==</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:size</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>

  <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='save identifier id'>save</span>
    <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Database error saving package #{pkg.name}: &quot;</span> <span class='plus op'>+</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='full_messages identifier id'>full_messages</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>', '</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='return return kw'>return</span> <span class='pkg identifier id'>pkg</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="was_deleted?-class_method">
  
    + (<tt>Boolean</tt>) <strong>was_deleted?</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Package.was_deleted? tells us if a package was created and subsequently
deleted.</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>name,</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the name of the package, e.g. E20111201_AAAAZR</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


86
87
88</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 86</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='was_deleted? fid id'>was_deleted?</span> <span class='name identifier id'>name</span>
  <span class='not not kw'>not</span> <span class='first identifier id'>first</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="delete-instance_method">
  
    - (<tt>Object</tt>) <strong>delete</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>delete attempts to remove all copies of a package and mark it as deleted.</p>

<p>On failure this may leave orphaned packages in remote silo pools. We’ll
raise an error that will ultimately return a 207 MultiStatus to the Storage
Master client.</p>

<p>TODO: add diagnostics to returned data from the quiet_delete call and pass
them up, if it proves necessary.</p>


  </div>
</div>
<div class="tags">
  
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../StorageMaster/SiloStoreError.html" title="StorageMaster::SiloStoreError (class)">SiloStoreError</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


251
252
253
254
255
256
257
258
259
260
261
262
263
264
265</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 251</span>

<span class='def def kw'>def</span> <span class='delete identifier id'>delete</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='extant identifier id'>extant</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>

  <span class='raise identifier id'>raise</span> <span class='SiloStoreError constant id'>SiloStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Error saving package #{name} to database: #{errors.full_messages.join(', ')}&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='save identifier id'>save</span>

  <span class='probs identifier id'>probs</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='copies identifier id'>copies</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='copy identifier id'>copy</span><span class='bitor op'>|</span>
    <span class='probs identifier id'>probs</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='copy identifier id'>copy</span><span class='dot token'>.</span><span class='store_location identifier id'>store_location</span> <span class='unless unless_mod kw'>unless</span> <span class='copy identifier id'>copy</span><span class='dot token'>.</span><span class='quiet_delete identifier id'>quiet_delete</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='probs identifier id'>probs</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    <span class='word identifier id'>word</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='probs identifier id'>probs</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='eq op'>==</span> <span class='integer val'>1</span> <span class='question op'>?</span> <span class='string val'>'entry'</span> <span class='colon op'>:</span> <span class='string val'>'entries'</span><span class='rparen token'>)</span>
    <span class='raise identifier id'>raise</span> <span class='PartialDelete constant id'>PartialDelete</span><span class='comma token'>,</span> <span class='dstring node'>&quot;For package #{name}, failed to delete silo #{word} #{probs.join(', ')}&quot;</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="locations-instance_method">
  
    - (<tt>ARRAY</tt>) <strong>locations</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Return the locations of outr package. It’s a list URI objects for all of
the copies we have, in pool-preference order. There may be username and
passwords on a URI object, but the URI#to_s method has been over-ridden so
they can’t be accidentally printed (use #to_s_with_userinfo for that,
defined in model.rb)</p>


  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>ARRAY</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>list of URI objects</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


61
62
63</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 61</span>

<span class='def def kw'>def</span> <span class='locations identifier id'>locations</span>
  <span class='copies identifier id'>copies</span><span class='dot token'>.</span><span class='sort identifier id'>sort</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='a identifier id'>a</span><span class='comma token'>,</span><span class='b identifier id'>b</span><span class='bitor op'>|</span> <span class='b identifier id'>b</span><span class='dot token'>.</span><span class='pool identifier id'>pool</span><span class='dot token'>.</span><span class='read_preference identifier id'>read_preference</span> <span class='cmp op'>&lt;=&gt;</span> <span class='a identifier id'>a</span><span class='dot token'>.</span><span class='pool identifier id'>pool</span><span class='dot token'>.</span><span class='read_preference identifier id'>read_preference</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='copy identifier id'>copy</span><span class='bitor op'>|</span> <span class='copy identifier id'>copy</span><span class='dot token'>.</span><span class='url identifier id'>url</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="url-instance_method">
  
    - (<tt>Object</tt>) <strong>url</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Return a string that gives the Stoage Master’s location of this package.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


67
68
69</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/storage-master/lib/storage-master/model/packages.rb', line 67</span>

<span class='def def kw'>def</span> <span class='url identifier id'>url</span>
  <span class='dstring node'>&quot;#{@@server_location || 'http://localhost'}/packages/#{name}&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Wed Nov 16 18:10:39 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.3 (ruby-1.8.7).
</div>

  </body>
</html>