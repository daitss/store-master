<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Module: StoreUtils</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (S)</a> &raquo; 
    
    
    <span class="title">StoreUtils</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Module: StoreUtils
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
You know the drawer in your kitchen that has all the junk in it?  This
module is like that&#8230;
</p>


  </div>
</div>
<div class="tags">
  
</div>


  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#base64_to_md5hex-class_method" title="base64_to_md5hex (class method)">+ (Object) <strong>base64_to_md5hex</strong>(string) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
This function does the reverse of the above, taking the base64 string and
returning the corresponding hex string.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#commify-class_method" title="commify (class method)">+ (Object) <strong>commify</strong>(num) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
put in commas in a number (American style numeric format).
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#disk_free-class_method" title="disk_free (class method)">+ (Object) <strong>disk_free</strong>(path) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#disk_id-class_method" title="disk_id (class method)">+ (Object) <strong>disk_id</strong>(path) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#disk_mount_point-class_method" title="disk_mount_point (class method)">+ (Object) <strong>disk_mount_point</strong>(path) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
N.B.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#disk_size-class_method" title="disk_size (class method)">+ (Object) <strong>disk_size</strong>(path) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_silo_options-class_method" title="get_silo_options (class method)">+ (Object) <strong>get_silo_options</strong>(args) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
StoreUtils.get_silo_options ARGS.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#group-class_method" title="group (class method)">+ (Object) <strong>group</strong>(path = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Without argument, return the group of the user running this process as a
string.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#hashpath-class_method" title="hashpath (class method)">+ (Object) <strong>hashpath</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#hashpath_parent-class_method" title="hashpath_parent (class method)">+ (Object) <strong>hashpath_parent</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#md5hex_to_base64-class_method" title="md5hex_to_base64 (class method)">+ (Object) <strong>md5hex_to_base64</strong>(hexstring) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
We need to provide the base64 of the original binary md5 checksum; however 
we typically have only the hexstring.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#mysql_config-class_method" title="mysql_config (class method)">+ (Object) <strong>mysql_config</strong>(key, pathname = &quot;/opt/fda/etc/db.yml&quot;) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
TODO:  default pathname should be required - also, error messages here on
missing yaml, etc.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#strip_trailing_slash_maybe-class_method" title="strip_trailing_slash_maybe (class method)">+ (Object) <strong>strip_trailing_slash_maybe</strong>(string) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#user-class_method" title="user (class method)">+ (Object) <strong>user</strong>(path = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Without argument, give the name of the user running this process as a
string.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#valid_ieid_name%3F-class_method" title="valid_ieid_name? (class method)">+ (Boolean) <strong>valid_ieid_name?</strong>(string) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="base64_to_md5hex-class_method">
  
    + (<tt>Object</tt>) <strong>base64_to_md5hex</strong>(string) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
This function does the reverse of the above, taking the base64 string and
returning the corresponding hex string.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


95
96
97
98</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 95</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='base64_to_md5hex identifier id'>base64_to_md5hex</span><span class='lparen token'>(</span><span class='string identifier id'>string</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span> <span class='unless unless_mod kw'>unless</span> <span class='lparen token'>(</span><span class='string identifier id'>string</span><span class='dot token'>.</span><span class='class identifier id'>class</span> <span class='eq op'>==</span> <span class='String constant id'>String</span> <span class='and and kw'>and</span> <span class='string identifier id'>string</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='eq op'>==</span> <span class='integer val'>24</span><span class='rparen token'>)</span>
  <span class='string identifier id'>string</span><span class='dot token'>.</span><span class='unpack identifier id'>unpack</span><span class='lparen token'>(</span><span class='string val'>&quot;m&quot;</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='unpack identifier id'>unpack</span><span class='lparen token'>(</span><span class='string val'>&quot;H2&quot;</span> <span class='mult op'>*</span> <span class='integer val'>16</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='join identifier id'>join</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="commify-class_method">
  
    + (<tt>Object</tt>) <strong>commify</strong>(num) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
put in commas in a number (American style numeric format)
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


198
199
200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 198</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='commify identifier id'>commify</span> <span class='num identifier id'>num</span>
  <span class='num identifier id'>num</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/(\d)(?=(\d\d\d)+(?!\d))/</span><span class='comma token'>,</span> <span class='string val'>&quot;\\1,&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="disk_free-class_method">
  
    + (<tt>Object</tt>) <strong>disk_free</strong>(path) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44
45</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 42</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='disk_free identifier id'>disk_free</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='fs identifier id'>fs</span> <span class='assign token'>=</span> <span class='Sys constant id'>Sys</span><span class='colon2 op'>::</span><span class='Filesystem constant id'>Filesystem</span><span class='dot token'>.</span><span class='stat identifier id'>stat</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='fs identifier id'>fs</span><span class='dot token'>.</span><span class='block_size identifier id'>block_size</span> <span class='mult op'>*</span> <span class='fs identifier id'>fs</span><span class='dot token'>.</span><span class='blocks_available identifier id'>blocks_available</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="disk_id-class_method">
  
    + (<tt>Object</tt>) <strong>disk_id</strong>(path) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


38
39
40</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 38</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='disk_id identifier id'>disk_id</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='stat identifier id'>stat</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='dev identifier id'>dev</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="disk_mount_point-class_method">
  
    + (<tt>Object</tt>) <strong>disk_mount_point</strong>(path) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
N.B. We depend on a trailing slash being removed
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 66</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='disk_mount_point identifier id'>disk_mount_point</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='path identifier id'>path</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='expand_path identifier id'>expand_path</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='path identifier id'>path</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='directory? fid id'>directory?</span> <span class='path identifier id'>path</span>
  <span class='path identifier id'>path</span> <span class='assign token'>=</span> <span class='path identifier id'>path</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>%r{/+$}</span><span class='comma token'>,</span> <span class='string val'>''</span><span class='rparen token'>)</span>
  
  <span class='id identifier id'>id</span> <span class='assign token'>=</span> <span class='disk_id identifier id'>disk_id</span> <span class='path identifier id'>path</span>
  <span class='components identifier id'>components</span> <span class='assign token'>=</span> <span class='path identifier id'>path</span><span class='dot token'>.</span><span class='split identifier id'>split</span> <span class='File constant id'>File</span><span class='colon2 op'>::</span><span class='SEPARATOR constant id'>SEPARATOR</span>  <span class='comment val'># break into path components and remove leading empty string</span>
  <span class='components identifier id'>components</span><span class='dot token'>.</span><span class='shift identifier id'>shift</span>
  
  <span class='topdown identifier id'>topdown</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='colon2 op'>::</span><span class='SEPARATOR constant id'>SEPARATOR</span>
  <span class='components identifier id'>components</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='c identifier id'>c</span><span class='bitor op'>|</span>
    <span class='return return kw'>return</span> <span class='strip_trailing_slash_maybe identifier id'>strip_trailing_slash_maybe</span><span class='lparen token'>(</span><span class='topdown identifier id'>topdown</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='disk_id identifier id'>disk_id</span><span class='lparen token'>(</span><span class='topdown identifier id'>topdown</span><span class='rparen token'>)</span> <span class='eq op'>==</span> <span class='id identifier id'>id</span>
    <span class='topdown identifier id'>topdown</span> <span class='opasgn op'>+=</span> <span class='c identifier id'>c</span> <span class='plus op'>+</span> <span class='File constant id'>File</span><span class='colon2 op'>::</span><span class='SEPARATOR constant id'>SEPARATOR</span>
  <span class='end end kw'>end</span>
  <span class='return return kw'>return</span> <span class='strip_trailing_slash_maybe identifier id'>strip_trailing_slash_maybe</span><span class='lparen token'>(</span><span class='topdown identifier id'>topdown</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="disk_size-class_method">
  
    + (<tt>Object</tt>) <strong>disk_size</strong>(path) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


47
48
49
50</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 47</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='disk_size identifier id'>disk_size</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='fs identifier id'>fs</span> <span class='assign token'>=</span> <span class='Sys constant id'>Sys</span><span class='colon2 op'>::</span><span class='Filesystem constant id'>Filesystem</span><span class='dot token'>.</span><span class='stat identifier id'>stat</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='fs identifier id'>fs</span><span class='dot token'>.</span><span class='block_size identifier id'>block_size</span> <span class='mult op'>*</span> <span class='fs identifier id'>fs</span><span class='dot token'>.</span><span class='blocks identifier id'>blocks</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get_silo_options-class_method">
  
    + (<tt>Object</tt>) <strong>get_silo_options</strong>(args) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
StoreUtils.get_silo_options ARGS
</p>
<p>
Parse the command line argments used for various silo fixity utility
programs.  Returns nil on error, after having written a message on STDERR
(usually you just want to exit with a non-zero exit status on a nil
return); on success returns a struct with the following
</p>
<pre class="code">
 <span class='mult op'>*</span> <span class='silo_path identifier id'>silo_path</span> <span class='PATH constant id'>PATH</span> <span class='lparen token'>(</span><span class='required identifier id'>required</span><span class='rparen token'>)</span> <span class='minus op'>-</span> <span class='the identifier id'>the</span> <span class='root identifier id'>root</span> <span class='of identifier id'>of</span> <span class='the identifier id'>the</span> <span class='filesystem identifier id'>filesystem</span> <span class='with identifier id'>with</span> <span class='the identifier id'>the</span> <span class='silo identifier id'>silo</span><span class='comma token'>,</span> <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='g identifier id'>g</span><span class='dot token'>.</span> <span class='div op'>/</span><span class='daitss identifier id'>daitss</span><span class='div op'>/</span><span class='integer val'>016</span><span class='div op'>/</span><span class='semicolon token'>;</span> <span class='it identifier id'>it</span> <span class='must identifier id'>must</span> <span class='be identifier id'>be</span> <span class='readable identifier id'>readable</span> <span class='lparen token'>(</span><span class='and and kw'>and</span> <span class='currently identifier id'>currently</span> <span class='writable identifier id'>writable</span><span class='comma token'>,</span> <span class='though identifier id'>though</span> <span class='that identifier id'>that</span><span class='string val'>'s a design flaw)
 * hostname  NAME (required) - the name of the host associated with this silo.
 * db_configuration_file FILEPATH (defaults to /opt/fda/etc/db.yml) - the path to a yaml file that provides db information
 * db_configuration_key STRING (required) - a key into the hash provided by reading the db_configuration_file, which will return a hash of db connection information.
 * syslog_facility FACILITY_CODE (optional) - if provided you should setup syslog to this facility, otherwise logging to STDERR
</span></pre>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 114</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='get_silo_options identifier id'>get_silo_options</span> <span class='args identifier id'>args</span>
  <span class='conf identifier id'>conf</span> <span class='assign token'>=</span> <span class='OpenStruct constant id'>OpenStruct</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='symbol val'>:hostname</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='symbol val'>:silo_path</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='symbol val'>:syslog_facility</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span>
                        <span class='symbol val'>:db_configuration_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='symbol val'>:db_configuration_file</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'/opt/fda/etc/db.yml'</span><span class='rparen token'>)</span>

  <span class='opts identifier id'>opts</span> <span class='assign token'>=</span> <span class='OptionParser constant id'>OptionParser</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='opts identifier id'>opts</span><span class='bitor op'>|</span>
    
    <span class='opts identifier id'>opts</span><span class='dot token'>.</span><span class='on identifier id'>on</span><span class='lparen token'>(</span><span class='string val'>&quot;--silo-path PATH&quot;</span><span class='comma token'>,</span>  <span class='String constant id'>String</span><span class='comma token'>,</span> <span class='string val'>&quot;The root of the filesystem with the silo, e.g. '/daitssfs/001/'&quot;</span><span class='rparen token'>)</span>  <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='path identifier id'>path</span><span class='bitor op'>|</span>
      <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='silo_path identifier id'>silo_path</span> <span class='assign token'>=</span> <span class='path identifier id'>path</span>
      <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='directory? fid id'>directory?</span> <span class='path identifier id'>path</span>
        <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;The silo-path supplied, #{path}, is not a directory.&quot;</span> 
      <span class='end end kw'>end</span>
      <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='writable? fid id'>writable?</span> <span class='path identifier id'>path</span>
        <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;The silo-path supplied, #{path} is owned by #{StoreUtils.user(path)} and is not writable by this process, which is running as user #{StoreUtils.user}.&quot;</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    
    <span class='opts identifier id'>opts</span><span class='dot token'>.</span><span class='on identifier id'>on</span><span class='lparen token'>(</span><span class='string val'>&quot;--syslog-facility FACILITY&quot;</span><span class='comma token'>,</span>  <span class='String constant id'>String</span><span class='comma token'>,</span> <span class='string val'>&quot;The facility in syslog to log to, otherwise log to STDERR&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='facility identifier id'>facility</span><span class='bitor op'>|</span>
      <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='syslog_facility identifier id'>syslog_facility</span> <span class='assign token'>=</span> <span class='facility identifier id'>facility</span>
    <span class='end end kw'>end</span>
    
    <span class='opts identifier id'>opts</span><span class='dot token'>.</span><span class='on identifier id'>on</span><span class='lparen token'>(</span><span class='string val'>&quot;--db-configuration-file PATH&quot;</span><span class='comma token'>,</span>  <span class='String constant id'>String</span><span class='comma token'>,</span> <span class='dstring node'>&quot;A database yaml configuration file, defaults to #{conf.db_configuration_file}&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='path identifier id'>path</span><span class='bitor op'>|</span>
      <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='db_configuration_file identifier id'>db_configuration_file</span> <span class='assign token'>=</span> <span class='path identifier id'>path</span>
    <span class='end end kw'>end</span>
    
    <span class='opts identifier id'>opts</span><span class='dot token'>.</span><span class='on identifier id'>on</span><span class='lparen token'>(</span><span class='string val'>&quot;--db-configuration-key KEY&quot;</span><span class='comma token'>,</span>  <span class='String constant id'>String</span><span class='comma token'>,</span> <span class='dstring node'>&quot;The key for the database information in the database yaml configuration file #{conf.db_configuration_file}&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='key identifier id'>key</span><span class='bitor op'>|</span>
      <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='db_configuration_key identifier id'>db_configuration_key</span> <span class='assign token'>=</span> <span class='key identifier id'>key</span>
    <span class='end end kw'>end</span>
    
    <span class='opts identifier id'>opts</span><span class='dot token'>.</span><span class='on identifier id'>on</span><span class='lparen token'>(</span><span class='string val'>&quot;--hostname HOST&quot;</span><span class='comma token'>,</span>   <span class='String constant id'>String</span><span class='comma token'>,</span> <span class='string val'>&quot;The name of the host this silo is associated with (usually a virtual host)&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='hostname identifier id'>hostname</span><span class='bitor op'>|</span>
      <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='hostname identifier id'>hostname</span> <span class='assign token'>=</span> <span class='hostname identifier id'>hostname</span><span class='dot token'>.</span><span class='downcase identifier id'>downcase</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='opts identifier id'>opts</span><span class='dot token'>.</span><span class='parse! fid id'>parse!</span><span class='lparen token'>(</span><span class='args identifier id'>args</span><span class='rparen token'>)</span> 
  <span class='raise identifier id'>raise</span> <span class='string val'>&quot;No path provided&quot;</span>      <span class='unless unless_mod kw'>unless</span> <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='silo_path identifier id'>silo_path</span>
  <span class='raise identifier id'>raise</span> <span class='string val'>&quot;No hostname provided&quot;</span>  <span class='unless unless_mod kw'>unless</span> <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='hostname identifier id'>hostname</span>
  <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;No key into the DB configuration file (#{conf.db_configuration_file}) provided&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='db_configuration_key identifier id'>db_configuration_key</span>
  <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Default yaml file #{conf.db_configuration_file} not found&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='conf identifier id'>conf</span><span class='dot token'>.</span><span class='db_configuration_file identifier id'>db_configuration_file</span>
  
<span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='STDERR constant id'>STDERR</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span> <span class='e identifier id'>e</span><span class='comma token'>,</span> <span class='opts identifier id'>opts</span>
  <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span>
<span class='else else kw'>else</span>
  <span class='return return kw'>return</span> <span class='conf identifier id'>conf</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="group-class_method">
  
    + (<tt>Object</tt>) <strong>group</strong>(path = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Without argument, return the group of the user running this process as a
string.  With argument PATH, a string, assume it is a readble filepath and
return the group name who owns it as a string.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


188
189
190
191
192
193
194</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 188</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='group identifier id'>group</span> <span class='path identifier id'>path</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='if if kw'>if</span> <span class='path identifier id'>path</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> 
    <span class='Etc constant id'>Etc</span><span class='dot token'>.</span><span class='getgrgid identifier id'>getgrgid</span><span class='lparen token'>(</span><span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='gid identifier id'>gid</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
  <span class='else else kw'>else</span>
    <span class='Etc constant id'>Etc</span><span class='dot token'>.</span><span class='getgrgid identifier id'>getgrgid</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='stat identifier id'>stat</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='uid identifier id'>uid</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="hashpath-class_method">
  
    + (<tt>Object</tt>) <strong>hashpath</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


160
161
162
163</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 160</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='hashpath identifier id'>hashpath</span> <span class='name identifier id'>name</span>
  <span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span>  <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span> <span class='name identifier id'>name</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='md5 identifier id'>md5</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='dot2 op'>..</span><span class='integer val'>2</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='md5 identifier id'>md5</span><span class='lbrack token'>[</span><span class='float val'>3</span><span class='dot2 op'>..</span><span class='integer val'>-1</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>      
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="hashpath_parent-class_method">
  
    + (<tt>Object</tt>) <strong>hashpath_parent</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


166
167
168</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 166</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='hashpath_parent identifier id'>hashpath_parent</span> <span class='name identifier id'>name</span>
  <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='dot2 op'>..</span><span class='integer val'>2</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="md5hex_to_base64-class_method">
  
    + (<tt>Object</tt>) <strong>md5hex_to_base64</strong>(hexstring) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
We need to provide the base64 of the original binary md5 checksum; however 
we typically have only the hexstring.  This funtion takes the hexstring,
packs it into the binary representation, then encodes that into a base64
representation.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


87
88
89
90</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 87</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='md5hex_to_base64 identifier id'>md5hex_to_base64</span><span class='lparen token'>(</span><span class='hexstring identifier id'>hexstring</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span> <span class='unless unless_mod kw'>unless</span> <span class='hexstring identifier id'>hexstring</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='eq op'>==</span> <span class='integer val'>32</span>
  <span class='lbrack token'>[</span><span class='hexstring identifier id'>hexstring</span><span class='dot token'>.</span><span class='scan identifier id'>scan</span><span class='lparen token'>(</span><span class='regexp val'>/../</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='pack identifier id'>pack</span><span class='lparen token'>(</span><span class='string val'>&quot;H2&quot;</span> <span class='mult op'>*</span> <span class='integer val'>16</span><span class='rparen token'>)</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='pack identifier id'>pack</span><span class='lparen token'>(</span><span class='string val'>&quot;m&quot;</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="mysql_config-class_method">
  
    + (<tt>Object</tt>) <strong>mysql_config</strong>(key, pathname = &quot;/opt/fda/etc/db.yml&quot;) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
TODO:  default pathname should be required - also, error messages here on
missing yaml, etc
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33
34
35
36</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 31</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='mysql_config identifier id'>mysql_config</span> <span class='key identifier id'>key</span><span class='comma token'>,</span> <span class='pathname identifier id'>pathname</span> <span class='assign token'>=</span> <span class='string val'>&quot;/opt/fda/etc/db.yml&quot;</span>
  <span class='hash identifier id'>hash</span> <span class='assign token'>=</span> <span class='YAML constant id'>YAML</span><span class='colon2 op'>::</span><span class='load identifier id'>load</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='pathname identifier id'>pathname</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='key identifier id'>key</span><span class='rbrack token'>]</span>
  <span class='OpenStruct constant id'>OpenStruct</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>'database'</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='hash identifier id'>hash</span><span class='lbrack token'>[</span><span class='string val'>'database'</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='string val'>'hostname'</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='hash identifier id'>hash</span><span class='lbrack token'>[</span><span class='string val'>'hostname'</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='string val'>'password'</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='hash identifier id'>hash</span><span class='lbrack token'>[</span><span class='string val'>'password'</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='string val'>'username'</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='hash identifier id'>hash</span><span class='lbrack token'>[</span><span class='string val'>'username'</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
<span class='rescue rescue kw'>rescue</span>
  <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="strip_trailing_slash_maybe-class_method">
  
    + (<tt>Object</tt>) <strong>strip_trailing_slash_maybe</strong>(string) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54
55</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 52</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='strip_trailing_slash_maybe identifier id'>strip_trailing_slash_maybe</span><span class='lparen token'>(</span><span class='string identifier id'>string</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='string identifier id'>string</span> <span class='if if_mod kw'>if</span> <span class='string identifier id'>string</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
  <span class='return return kw'>return</span> <span class='string identifier id'>string</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='dregexp node'>/#{File::SEPARATOR}+$/</span><span class='comma token'>,</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="user-class_method">
  
    + (<tt>Object</tt>) <strong>user</strong>(path = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Without argument, give the name of the user running this process as a
string.  With argument PATH, a string, assume it is a readable filepath and
return the user name who owns it as a string.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


175
176
177
178
179
180
181</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 175</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='user identifier id'>user</span> <span class='path identifier id'>path</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='if if kw'>if</span> <span class='path identifier id'>path</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='Etc constant id'>Etc</span><span class='dot token'>.</span><span class='getpwuid identifier id'>getpwuid</span><span class='lparen token'>(</span><span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='uid identifier id'>uid</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
  <span class='else else kw'>else</span>
    <span class='Etc constant id'>Etc</span><span class='dot token'>.</span><span class='getpwuid identifier id'>getpwuid</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='stat identifier id'>stat</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='uid identifier id'>uid</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="valid_ieid_name?-class_method">
  
    + (<tt>Boolean</tt>) <strong>valid_ieid_name?</strong>(string) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/utils.rb', line 57</span>

<span class='def def kw'>def</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='valid_ieid_name? fid id'>valid_ieid_name?</span> <span class='string identifier id'>string</span>
  <span class='string identifier id'>string</span> <span class='match op'>=~</span> <span class='regexp val'>/^E[A-Z0-9]{8}_[A-Z0-9]{6}$/</span> <span class='question op'>?</span> <span class='true true kw'>true</span> <span class='colon op'>:</span> <span class='false false kw'>false</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Thu Dec  2 14:52:44 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.0 (ruby-1.8.7).
</div>

  </body>
</html>