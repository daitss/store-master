<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Class: Store::Package</title>
<link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (P)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Store.html" title="Store (module)">Store</a></span></span>
     &raquo; 
    <span class="title">Package</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Store::Package
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Store::Package</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb</dd>
  
</dl>
<div class="clear"></div>



  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#dm_record-instance_method" title="#dm_record (instance method)">- (Object) <strong>dm_record</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute dm_record.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#etag-instance_method" title="#etag (instance method)">- (Object) <strong>etag</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute etag.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#ieid-instance_method" title="#ieid (instance method)">- (Object) <strong>ieid</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute ieid.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#locations-instance_method" title="#locations (instance method)">- (Object) <strong>locations</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute locations.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#md5-instance_method" title="#md5 (instance method)">- (Object) <strong>md5</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute md5.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#name-instance_method" title="#name (instance method)">- (Object) <strong>name</strong> </a>
    

    
  </span>
  
  
    <span class="note title readonly">readonly</span>
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute name.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#sha1-instance_method" title="#sha1 (instance method)">- (Object) <strong>sha1</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute sha1.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#size-instance_method" title="#size (instance method)">- (Object) <strong>size</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute size.
</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#type-instance_method" title="#type (instance method)">- (Object) <strong>type</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute type.
</p>
</div></span>
  
</li>

    
  </ul>


  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-class_method" title="create (class method)">+ (Object) <strong>create</strong>(io, metadata, pools) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#exists%3F-class_method" title="exists? (class method)">+ (Boolean) <strong>exists?</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lookup-class_method" title="lookup (class method)">+ (Object) <strong>lookup</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Find a previously saved package.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#names-class_method" title="names (class method)">+ (Object) <strong>names</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
TODO: This next is likely to result in such a long list as to be unusable
in practice; need to rethink chunking this up, perhaps with yield.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#was_deleted%3F-class_method" title="was_deleted? (class method)">+ (Boolean) <strong>was_deleted?</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete-instance_method" title="#delete (instance method)">- (Object) <strong>delete</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
delete tries to fail safe here, leaving orphans if necessary.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete_copy-instance_method" title="#delete_copy (instance method)">- (Object) <strong>delete_copy</strong>(remote_location) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Package) <strong>initialize</strong>(name) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Package.new(name) really meant to only be called internally.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#put_copy-instance_method" title="#put_copy (instance method)">- (Object) <strong>put_copy</strong>(io, metadata, remote_location) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Store::Package (class)">Package</a></span></tt>) <strong>initialize</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Package.new(name) really meant to only be called internally.  Use lookup or
create
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


19
20
21
22
23</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 19</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='name identifier id'>name</span>
  <span class='@name ivar id'>@name</span>      <span class='assign token'>=</span> <span class='name identifier id'>name</span>
  <span class='@dm_record ivar id'>@dm_record</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='@locations ivar id'>@locations</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="dm_record=-instance_method"></span>
      <span id="dm_record-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="dm_record-instance_method">
  
    - (<tt>Object</tt>) <strong>dm_record</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute dm_record
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 15</span>

<span class='def def kw'>def</span> <span class='dm_record identifier id'>dm_record</span>
  <span class='@dm_record ivar id'>@dm_record</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="etag=-instance_method"></span>
      <span id="etag-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="etag-instance_method">
  
    - (<tt>Object</tt>) <strong>etag</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute etag
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 15</span>

<span class='def def kw'>def</span> <span class='etag identifier id'>etag</span>
  <span class='@etag ivar id'>@etag</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="ieid=-instance_method"></span>
      <span id="ieid-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="ieid-instance_method">
  
    - (<tt>Object</tt>) <strong>ieid</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute ieid
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 15</span>

<span class='def def kw'>def</span> <span class='ieid identifier id'>ieid</span>
  <span class='@ieid ivar id'>@ieid</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="locations=-instance_method"></span>
      <span id="locations-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="locations-instance_method">
  
    - (<tt>Object</tt>) <strong>locations</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute locations
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 15</span>

<span class='def def kw'>def</span> <span class='locations identifier id'>locations</span>
  <span class='@locations ivar id'>@locations</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="md5=-instance_method"></span>
      <span id="md5-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="md5-instance_method">
  
    - (<tt>Object</tt>) <strong>md5</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute md5
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 15</span>

<span class='def def kw'>def</span> <span class='md5 identifier id'>md5</span>
  <span class='@md5 ivar id'>@md5</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <span id="name-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="name-instance_method">
  
    - (<tt>Object</tt>) <strong>name</strong>  <span class="extras">(readonly)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute name
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


14
15
16</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 14</span>

<span class='def def kw'>def</span> <span class='name identifier id'>name</span>
  <span class='@name ivar id'>@name</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="sha1=-instance_method"></span>
      <span id="sha1-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="sha1-instance_method">
  
    - (<tt>Object</tt>) <strong>sha1</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute sha1
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 15</span>

<span class='def def kw'>def</span> <span class='sha1 identifier id'>sha1</span>
  <span class='@sha1 ivar id'>@sha1</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="size=-instance_method"></span>
      <span id="size-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="size-instance_method">
  
    - (<tt>Object</tt>) <strong>size</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute size
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 15</span>

<span class='def def kw'>def</span> <span class='size identifier id'>size</span>
  <span class='@size ivar id'>@size</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="type=-instance_method"></span>
      <span id="type-instance_method"></span>
      <div class="method_details ">
  <p class="signature " id="type-instance_method">
  
    - (<tt>Object</tt>) <strong>type</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute type
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 15</span>

<span class='def def kw'>def</span> <span class='type identifier id'>type</span>
  <span class='@type ivar id'>@type</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="create-class_method">
  
    + (<tt>Object</tt>) <strong>create</strong>(io, metadata, pools) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 51</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='create identifier id'>create</span> <span class='io identifier id'>io</span><span class='comma token'>,</span> <span class='metadata identifier id'>metadata</span><span class='comma token'>,</span> <span class='pools identifier id'>pools</span>

  <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='ieid identifier id'>ieid</span> <span class='assign token'>=</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:ieid</span><span class='rbrack token'>]</span>

  <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Can't create new package #{name}, it already exists&quot;</span>                   <span class='if if_mod kw'>if</span> <span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='name identifier id'>name</span>
  <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Can't reuse name #{name}: it has been previously created and deleted&quot;</span>  <span class='if if_mod kw'>if</span> <span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='was_deleted? fid id'>was_deleted?</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>

  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span> <span class='assign token'>=</span> <span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='create identifier id'>create</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='ieid identifier id'>ieid</span> <span class='assign token'>=</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='ieid identifier id'>ieid</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='assign token'>=</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='name identifier id'>name</span>

  <span class='begin begin kw'>begin</span>
    <span class='pools identifier id'>pools</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='pool identifier id'>pool</span><span class='bitor op'>|</span>
      <span class='loc identifier id'>loc</span> <span class='assign token'>=</span> <span class='pool identifier id'>pool</span><span class='dot token'>.</span><span class='put_location identifier id'>put_location</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>%r{/+$}</span><span class='comma token'>,</span> <span class='string val'>''</span><span class='rparen token'>)</span>  <span class='plus op'>+</span>  <span class='string val'>'/'</span>  <span class='plus op'>+</span>  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
      <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='copies identifier id'>copies</span> <span class='lshft op'>&lt;&lt;</span> <span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Copy constant id'>Copy</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:store_location</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='loc identifier id'>loc</span><span class='comma token'>,</span> <span class='symbol val'>:pool</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='pool identifier id'>pool</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span><span class='rparen token'>)</span>
      <span class='comment val'>### TODO: record events here? transact?</span>
      <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='put_copy identifier id'>put_copy</span><span class='lparen token'>(</span><span class='io identifier id'>io</span><span class='comma token'>,</span> <span class='metadata identifier id'>metadata</span><span class='comma token'>,</span> <span class='loc identifier id'>loc</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e1 identifier id'>e1</span>
    <span class='msg identifier id'>msg</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;Failure storing copy of #{pkg.name}: #{e1.message}&quot;</span>
    <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='locations identifier id'>locations</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='loc identifier id'>loc</span><span class='bitor op'>|</span> 
      <span class='begin begin kw'>begin</span>
        <span class='delete_copy identifier id'>delete_copy</span><span class='lparen token'>(</span><span class='loc identifier id'>loc</span><span class='rparen token'>)</span>
      <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e2 identifier id'>e2</span>
        <span class='msg identifier id'>msg</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;; also, failure deleting copy at #{loc}: #{e2.message}&quot;</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    <span class='raise identifier id'>raise</span> <span class='e1 identifier id'>e1</span><span class='comma token'>,</span> <span class='msg identifier id'>msg</span> <span class='comment val'># re-raise error</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='save identifier id'>save</span>
    <span class='msg identifier id'>msg</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;DB error recording #{name} - #{pkg.dm_record.errors.map { |e| e.to_s }.join('; ')}&quot;</span>
    <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='locations identifier id'>locations</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='loc identifier id'>loc</span><span class='bitor op'>|</span> 
      <span class='begin begin kw'>begin</span>
        <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='delete_copy identifier id'>delete_copy</span><span class='lparen token'>(</span><span class='loc identifier id'>loc</span><span class='rparen token'>)</span>
      <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
        <span class='msg identifier id'>msg</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;; also, failure deleting copy at #{loc}: #{e.message}&quot;</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    <span class='raise identifier id'>raise</span> <span class='DataBaseError constant id'>DataBaseError</span><span class='comma token'>,</span> <span class='msg identifier id'>msg</span>
  <span class='end end kw'>end</span>

  <span class='pkg identifier id'>pkg</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="exists?-class_method">
  
    + (<tt>Boolean</tt>) <strong>exists?</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


25
26
27</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 25</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='name identifier id'>name</span>
  <span class='not not kw'>not</span> <span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="lookup-class_method">
  
    + (<tt>Object</tt>) <strong>lookup</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Find a previously saved package
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


38
39
40
41
42
43
44
45</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 38</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='lookup identifier id'>lookup</span> <span class='name identifier id'>name</span>
  <span class='pkg identifier id'>pkg</span> <span class='assign token'>=</span> <span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='name identifier id'>name</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span> <span class='assign token'>=</span> <span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span> <span class='if if_mod kw'>if</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='ieid identifier id'>ieid</span> <span class='assign token'>=</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='ieid identifier id'>ieid</span>
  <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='locations identifier id'>locations</span> <span class='assign token'>=</span> <span class='pkg identifier id'>pkg</span><span class='dot token'>.</span><span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='copies identifier id'>copies</span><span class='dot token'>.</span><span class='sort identifier id'>sort</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='a identifier id'>a</span><span class='comma token'>,</span><span class='b identifier id'>b</span><span class='bitor op'>|</span> <span class='b identifier id'>b</span><span class='dot token'>.</span><span class='pool identifier id'>pool</span><span class='dot token'>.</span><span class='read_preference identifier id'>read_preference</span> <span class='cmp op'>&lt;=&gt;</span> <span class='a identifier id'>a</span><span class='dot token'>.</span><span class='pool identifier id'>pool</span><span class='dot token'>.</span><span class='read_preference identifier id'>read_preference</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='cp identifier id'>cp</span><span class='bitor op'>|</span> <span class='cp identifier id'>cp</span><span class='dot token'>.</span><span class='store_location identifier id'>store_location</span> <span class='rbrace token'>}</span>
  <span class='pkg identifier id'>pkg</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="names-class_method">
  
    + (<tt>Object</tt>) <strong>names</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
TODO: This next is likely to result in such a long list as to be unusable
in practice; need to rethink chunking this up, perhaps with yield
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


32
33
34</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 32</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='names identifier id'>names</span>
  <span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='all identifier id'>all</span><span class='lparen token'>(</span><span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span> <span class='symbol val'>:name</span><span class='dot token'>.</span><span class='asc identifier id'>asc</span> <span class='rbrack token'>]</span> <span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='rec identifier id'>rec</span><span class='bitor op'>|</span> <span class='rec identifier id'>rec</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="was_deleted?-class_method">
  
    + (<tt>Boolean</tt>) <strong>was_deleted?</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


47
48
49</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 47</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='was_deleted? fid id'>was_deleted?</span> <span class='name identifier id'>name</span>
  <span class='not not kw'>not</span> <span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Package constant id'>Package</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='symbol val'>:extant</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="delete-instance_method">
  
    - (<tt>Object</tt>) <strong>delete</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
delete tries to fail safe here, leaving orphans if necessary
</p>


  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="DataBaseError.html" title="Store::DataBaseError (class)">DataBaseError</a></span></tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


121
122
123
124
125
126
127
128
129
130
131
132
133
134
135</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 121</span>

<span class='def def kw'>def</span> <span class='delete identifier id'>delete</span>
  <span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='extant identifier id'>extant</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='raise identifier id'>raise</span>  <span class='DataBaseError constant id'>DataBaseError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;error deleting #{name} - #{pkg.dm_record.errors.map { |e| e.to_s }.join('; ')}&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='dm_record identifier id'>dm_record</span><span class='dot token'>.</span><span class='save identifier id'>save</span>

  <span class='errors identifier id'>errors</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='locations identifier id'>locations</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='loc identifier id'>loc</span><span class='bitor op'>|</span> 
    <span class='begin begin kw'>begin</span>
      <span class='delete_copy identifier id'>delete_copy</span><span class='lparen token'>(</span><span class='loc identifier id'>loc</span><span class='rparen token'>)</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='dstring node'>&quot;failed to delete remote storage at #{loc}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  
  <span class='raise identifier id'>raise</span> <span class='DriveByError constant id'>DriveByError</span><span class='comma token'>,</span> <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>'; '</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="delete_copy-instance_method">
  
    - (<tt>Object</tt>) <strong>delete_copy</strong>(remote_location) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 138</span>

<span class='def def kw'>def</span> <span class='delete_copy identifier id'>delete_copy</span> <span class='remote_location identifier id'>remote_location</span>

  <span class='uri identifier id'>uri</span> <span class='assign token'>=</span> <span class='URI constant id'>URI</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='remote_location identifier id'>remote_location</span><span class='rparen token'>)</span>
  <span class='http identifier id'>http</span> <span class='assign token'>=</span> <span class='Net constant id'>Net</span><span class='colon2 op'>::</span><span class='HTTP constant id'>HTTP</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='host identifier id'>host</span><span class='comma token'>,</span> <span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='port identifier id'>port</span><span class='rparen token'>)</span>
  <span class='http identifier id'>http</span><span class='dot token'>.</span><span class='open_timeout identifier id'>open_timeout</span> <span class='assign token'>=</span> <span class='integer val'>5</span>
  <span class='http identifier id'>http</span><span class='dot token'>.</span><span class='read_timeout identifier id'>read_timeout</span> <span class='assign token'>=</span> <span class='integer val'>60</span> <span class='mult op'>*</span> <span class='integer val'>30</span>  <span class='comment val'># thirty minute timeout for delete (since PUTs can block us from a full silo for this long!)</span>

  <span class='forwarded_request identifier id'>forwarded_request</span> <span class='assign token'>=</span> <span class='Net constant id'>Net</span><span class='colon2 op'>::</span><span class='HTTP constant id'>HTTP</span><span class='colon2 op'>::</span><span class='Delete constant id'>Delete</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='request_uri identifier id'>request_uri</span><span class='rparen token'>)</span>
  <span class='response identifier id'>response</span> <span class='assign token'>=</span> <span class='http identifier id'>http</span><span class='dot token'>.</span><span class='request identifier id'>request</span><span class='lparen token'>(</span><span class='forwarded_request identifier id'>forwarded_request</span><span class='rparen token'>)</span>
  <span class='status identifier id'>status</span> <span class='assign token'>=</span> <span class='response identifier id'>response</span><span class='dot token'>.</span><span class='code identifier id'>code</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>

  <span class='if if kw'>if</span> <span class='status identifier id'>status</span> <span class='geq op'>&gt;=</span> <span class='integer val'>300</span>
    <span class='err identifier id'>err</span>   <span class='assign token'>=</span> <span class='dstring node'>&quot;#{response.code} #{response.message} was returned for a failed delete of the package copy at #{remote_location}&quot;</span>
    <span class='err identifier id'>err</span>  <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;; #{response.body}&quot;</span> <span class='if if_mod kw'>if</span> <span class='response identifier id'>response</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
    <span class='if if kw'>if</span> <span class='status identifier id'>status</span> <span class='geq op'>&gt;=</span> <span class='integer val'>500</span>   
      <span class='raise identifier id'>raise</span> <span class='err identifier id'>err</span>
    <span class='elsif elsif kw'>elsif</span> <span class='status identifier id'>status</span> <span class='geq op'>&gt;=</span> <span class='integer val'>400</span> 
      <span class='raise identifier id'>raise</span> <span class='Silo400Error constant id'>Silo400Error</span><span class='comma token'>,</span> <span class='err identifier id'>err</span>
    <span class='elsif elsif kw'>elsif</span> <span class='status identifier id'>status</span> <span class='geq op'>&gt;=</span> <span class='integer val'>300</span>    
      <span class='raise identifier id'>raise</span> <span class='err identifier id'>err</span>
    <span class='end end kw'>end</span>          
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="put_copy-instance_method">
  
    - (<tt>Object</tt>) <strong>put_copy</strong>(io, metadata, remote_location) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/package.rb', line 162</span>

<span class='def def kw'>def</span> <span class='put_copy identifier id'>put_copy</span> <span class='io identifier id'>io</span><span class='comma token'>,</span> <span class='metadata identifier id'>metadata</span><span class='comma token'>,</span> <span class='remote_location identifier id'>remote_location</span>

  <span class='uri identifier id'>uri</span>  <span class='assign token'>=</span> <span class='URI constant id'>URI</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='remote_location identifier id'>remote_location</span><span class='rparen token'>)</span>
  <span class='http identifier id'>http</span> <span class='assign token'>=</span> <span class='Net constant id'>Net</span><span class='colon2 op'>::</span><span class='HTTP constant id'>HTTP</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='host identifier id'>host</span><span class='comma token'>,</span> <span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='port identifier id'>port</span><span class='rparen token'>)</span>

  <span class='http identifier id'>http</span><span class='dot token'>.</span><span class='open_timeout identifier id'>open_timeout</span> <span class='assign token'>=</span> <span class='integer val'>5</span>
  <span class='http identifier id'>http</span><span class='dot token'>.</span><span class='read_timeout identifier id'>read_timeout</span> <span class='assign token'>=</span> <span class='integer val'>60</span> <span class='mult op'>*</span> <span class='integer val'>30</span>  <span class='comment val'># thirty minute timeout for PUTs</span>

  <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='rewind identifier id'>rewind</span> <span class='if if_mod kw'>if</span> <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='string val'>'rewind'</span><span class='rparen token'>)</span>

  <span class='forwarded_request identifier id'>forwarded_request</span> <span class='assign token'>=</span> <span class='Net constant id'>Net</span><span class='colon2 op'>::</span><span class='HTTP constant id'>HTTP</span><span class='colon2 op'>::</span><span class='Put constant id'>Put</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='uri identifier id'>uri</span><span class='dot token'>.</span><span class='request_uri identifier id'>request_uri</span><span class='rparen token'>)</span>
  <span class='forwarded_request identifier id'>forwarded_request</span><span class='dot token'>.</span><span class='body_stream identifier id'>body_stream</span> <span class='assign token'>=</span> <span class='io identifier id'>io</span>
  <span class='forwarded_request identifier id'>forwarded_request</span><span class='dot token'>.</span><span class='initialize_http_header identifier id'>initialize_http_header</span><span class='lparen token'>(</span><span class='lbrace token'>{</span> <span class='string val'>&quot;Content-MD5&quot;</span>    <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='md5hex_to_base64 identifier id'>md5hex_to_base64</span><span class='lparen token'>(</span><span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:md5</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;Content-Length&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:size</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='comma token'>,</span> <span class='string val'>&quot;Content-Type&quot;</span>   <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span>

  <span class='response identifier id'>response</span> <span class='assign token'>=</span> <span class='http identifier id'>http</span><span class='dot token'>.</span><span class='request identifier id'>request</span><span class='lparen token'>(</span><span class='forwarded_request identifier id'>forwarded_request</span><span class='rparen token'>)</span>

  <span class='status identifier id'>status</span> <span class='assign token'>=</span> <span class='response identifier id'>response</span><span class='dot token'>.</span><span class='code identifier id'>code</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>

  <span class='if if kw'>if</span> <span class='status identifier id'>status</span> <span class='geq op'>&gt;=</span> <span class='integer val'>300</span>
    <span class='err identifier id'>err</span>   <span class='assign token'>=</span> <span class='dstring node'>&quot;#{response.code} #{response.message} was returned for a failed forward of package to #{remote_location}&quot;</span>
    <span class='err identifier id'>err</span>  <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;; message was #{response.body}&quot;</span> <span class='if if_mod kw'>if</span> <span class='response identifier id'>response</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
    <span class='if if kw'>if</span> <span class='status identifier id'>status</span> <span class='geq op'>&gt;=</span> <span class='integer val'>500</span>   
      <span class='raise identifier id'>raise</span> <span class='err identifier id'>err</span>
    <span class='elsif elsif kw'>elsif</span> <span class='status identifier id'>status</span> <span class='geq op'>&gt;=</span> <span class='integer val'>400</span> 
      <span class='raise identifier id'>raise</span> <span class='Silo400Error constant id'>Silo400Error</span><span class='comma token'>,</span> <span class='err identifier id'>err</span>
    <span class='elsif elsif kw'>elsif</span> <span class='status identifier id'>status</span> <span class='geq op'>&gt;=</span> <span class='integer val'>300</span>    
      <span class='raise identifier id'>raise</span> <span class='err identifier id'>err</span>
    <span class='end end kw'>end</span>          
  <span class='end end kw'>end</span>


  <span class='comment val'># Example XML document returned from PUT:    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
  <span class='comment val'>#                                            &lt;created type=&quot;application/x-tar&quot; </span>
  <span class='comment val'>#                                                     time=&quot;2010-10-21T10:29:19-04:00&quot; </span>
  <span class='comment val'>#                                                     sha1=&quot;ac4d813081e066422bc1dc7e7997ace1bfb858b2&quot; </span>
  <span class='comment val'>#                                                     etag=&quot;a3f07bc57127112f2a2c40d026b1abe1&quot; </span>
  <span class='comment val'>#                                                     md5=&quot;32e2ce3af2f98a115e121285d042c9bd&quot; </span>
  <span class='comment val'>#                                                     size=&quot;6031360&quot; </span>
  <span class='comment val'>#                                                     location=&quot;http://storage.local/b/data/E20101021_LJLAMU.001&quot; </span>
  <span class='comment val'>#                                                     name=&quot;E20101021_LJLAMU.001&quot;/&gt;</span>


  <span class='returned_data identifier id'>returned_data</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

  <span class='begin begin kw'>begin</span> 
    <span class='parser identifier id'>parser</span> <span class='assign token'>=</span> <span class='XML constant id'>XML</span><span class='colon2 op'>::</span><span class='Parser constant id'>Parser</span><span class='dot token'>.</span><span class='string identifier id'>string</span><span class='lparen token'>(</span><span class='response identifier id'>response</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span>
    <span class='node identifier id'>node</span>   <span class='assign token'>=</span> <span class='parser identifier id'>parser</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='string val'>'/created'</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
    <span class='node identifier id'>node</span><span class='dot token'>.</span><span class='each_attr identifier id'>each_attr</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='attr identifier id'>attr</span><span class='bitor op'>|</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='attr identifier id'>attr</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='attr identifier id'>attr</span><span class='dot token'>.</span><span class='value identifier id'>value</span> <span class='rbrace token'>}</span>
  <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
    <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Invalid XML document returned in response to forward of package to #{remote_location}: #{e.message}&quot;</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># check the md5, size, type vs. our request to that returned by remotely created copy.</span>

  <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Error storing to #{remote_location} - md5 mismatch&quot;</span>   <span class='if if_mod kw'>if</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;md5&quot;</span><span class='rbrack token'>]</span>  <span class='neq op'>!=</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:md5</span><span class='rbrack token'>]</span>
  <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Error storing to #{remote_location} - size mismatch&quot;</span>  <span class='if if_mod kw'>if</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;size&quot;</span><span class='rbrack token'>]</span> <span class='neq op'>!=</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:size</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
  <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Error storing to #{remote_location} - type mismatch&quot;</span>  <span class='if if_mod kw'>if</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;type&quot;</span><span class='rbrack token'>]</span> <span class='neq op'>!=</span> <span class='metadata identifier id'>metadata</span><span class='lbrack token'>[</span><span class='symbol val'>:type</span><span class='rbrack token'>]</span>

  <span class='@md5 ivar id'>@md5</span>  <span class='assign token'>=</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;md5&quot;</span><span class='rbrack token'>]</span>
  <span class='@sha1 ivar id'>@sha1</span> <span class='assign token'>=</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;sha1&quot;</span><span class='rbrack token'>]</span>
  <span class='@type ivar id'>@type</span> <span class='assign token'>=</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;type&quot;</span><span class='rbrack token'>]</span>
  <span class='@size ivar id'>@size</span> <span class='assign token'>=</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;size&quot;</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
  <span class='@etag ivar id'>@etag</span> <span class='assign token'>=</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;etag&quot;</span><span class='rbrack token'>]</span>
  <span class='@locations ivar id'>@locations</span> <span class='lshft op'>&lt;&lt;</span> <span class='returned_data identifier id'>returned_data</span><span class='lbrack token'>[</span><span class='string val'>&quot;location&quot;</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Tue Dec  7 17:58:05 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.0 (ruby-1.8.7).
</div>

  </body>
</html>