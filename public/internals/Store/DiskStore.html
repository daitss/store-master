<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Class: Store::DiskStore</title>
<link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (D)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Store.html" title="Store (module)">Store</a></span></span>
     &raquo; 
    <span class="title">DiskStore</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Store::DiskStore
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Store::DiskStore</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">Enumerable</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb</dd>
  
</dl>
<div class="clear"></div>


  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="RESTRICTIVE_FILE_PERMISSIONS-constant" class="">RESTRICTIVE_FILE_PERMISSIONS =
          
        </dt>
        <dd><pre class="code"><span class='integer val'>0444</span>
</pre></dd>
      
        <dt id="RESTRICTIVE_DIRECTORY_PERMISSIONS-constant" class="">RESTRICTIVE_DIRECTORY_PERMISSIONS =
          
        </dt>
        <dd><pre class="code"><span class='integer val'>0555</span>
</pre></dd>
      
        <dt id="PERMISSIVE_DIRECTORY_PERMISSIONS-constant" class="">PERMISSIVE_DIRECTORY_PERMISSIONS =
          
        </dt>
        <dd><pre class="code"><span class='integer val'>0755</span>
</pre></dd>
      
        <dt id="MAX_NAME_LENGTH-constant" class="">MAX_NAME_LENGTH =
          
        </dt>
        <dd><pre class="code"><span class='integer val'>512</span>
</pre></dd>
      
        <dt id="LOCK_FILENAME-constant" class="">LOCK_FILENAME =
          
        </dt>
        <dd><pre class="code"><span class='string val'>&quot;.lock&quot;</span>
</pre></dd>
      
        <dt id="IO_BUFFER_SIZE-constant" class="">IO_BUFFER_SIZE =
          <div class="docstring">
  <div class="discussion">
    <p>
buffer size in bytes for reading/writing
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='integer val'>1024</span> <span class='pow op'>**</span> <span class='integer val'>2</span>
</pre></dd>
      
        <dt id="LOCKFILE_GRAB_TIMEOUT-constant" class="">LOCKFILE_GRAB_TIMEOUT =
          <div class="docstring">
  <div class="discussion">
    <p>
seconds to wait on a lock file before we throw an error
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='integer val'>60</span> <span class='mult op'>*</span> <span class='integer val'>10</span>
</pre></dd>
      
        <dt id="HEADROOM-constant" class="">HEADROOM =
          <div class="docstring">
  <div class="discussion">
    <p>
we have to have this many bytes free to perfom a PUT
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='integer val'>50</span> <span class='mult op'>*</span> <span class='integer val'>1024</span> <span class='mult op'>*</span> <span class='integer val'>1024</span>
</pre></dd>
      
    </dl>
  


  
  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#filesystem-instance_method" title="#filesystem (instance method)">- (Object) <strong>filesystem</strong> </a>
    

    
  </span>
  
  
    <span class="note title readonly">readonly</span>
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the value of attribute filesystem.
</p>
</div></span>
  
</li>

    
  </ul>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#data_path-instance_method" title="#data_path (instance method)">- (Object) <strong>data_path</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#datetime-instance_method" title="#datetime (instance method)">- (Object) <strong>datetime</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Return the iso8601 representation of date/time of the data described by
name.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#datetime_path-instance_method" title="#datetime_path (instance method)">- (Object) <strong>datetime_path</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#delete-instance_method" title="#delete (instance method)">- (Object) <strong>delete</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Delete data identified by name.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#describe-instance_method" title="#describe (instance method)">- (Object) <strong>describe</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Mostly for error messages:.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#dopen-instance_method" title="#dopen (instance method)">- (Object) <strong>dopen</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
For those times when you really, really need an io object on the data.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#each-instance_method" title="#each (instance method)">- (Object) <strong>each</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Used to mixin enumerable&#8217;s such as grep, etc.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#etag-instance_method" title="#etag (instance method)">- (Object) <strong>etag</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#exists%3F-instance_method" title="#exists? (instance method)">- (Boolean) <strong>exists?</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns true if a data identified by name is in the silo.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get-instance_method" title="#get (instance method)">- (Object) <strong>get</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Get data identified by name from the silo.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (DiskStore) <strong>initialize</strong>(storage_directory_root) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
A new instance of DiskStore.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#invalid_name%3F-instance_method" title="#invalid_name? (instance method)">- (Boolean) <strong>invalid_name?</strong>(string) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
What&#8217;s in a name?  no embedded control characters, that&#8217;s for
sure.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#last_access-instance_method" title="#last_access (instance method)">- (Object) <strong>last_access</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#md5-instance_method" title="#md5 (instance method)">- (Object) <strong>md5</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the (saved) md5 hexdigest of data identified by name.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#md5_path-instance_method" title="#md5_path (instance method)">- (Object) <strong>md5_path</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#name_path-instance_method" title="#name_path (instance method)">- (Object) <strong>name_path</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parent_path-instance_method" title="#parent_path (instance method)">- (Object) <strong>parent_path</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#path-instance_method" title="#path (instance method)">- (Object) <strong>path</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Return the filesystem paths of the various meta/data associated with and
object identified by name.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#put-instance_method" title="#put (instance method)">- (Object) <strong>put</strong>(name, data, type) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Put data identified by name in the silo.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#read_lock-instance_method" title="#read_lock (instance method)">- (Object) <strong>read_lock</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
read shared lock - any one can get another read lock, but no-one can get an
exclusive (write) lock.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sha1-instance_method" title="#sha1 (instance method)">- (Object) <strong>sha1</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the saved sha1 hexdigest of data.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sha1_path-instance_method" title="#sha1_path (instance method)">- (Object) <strong>sha1_path</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#size-instance_method" title="#size (instance method)">- (Object) <strong>size</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Return the size (in bytes) of the data described by name.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_s-instance_method" title="#to_s (instance method)">- (Object) <strong>to_s</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#type-instance_method" title="#type (instance method)">- (Object) <strong>type</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns the content type of the data.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#type_path-instance_method" title="#type_path (instance method)">- (Object) <strong>type_path</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#write_lock-instance_method" title="#write_lock (instance method)">- (Object) <strong>write_lock</strong>(name) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Write and read use fstat to lock: once a write lock is acquired, no one
else can get a lock to read (a shared lock) or write (an exclusive lock).
</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Store::DiskStore (class)">DiskStore</a></span></tt>) <strong>initialize</strong>(storage_directory_root) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
A new instance of DiskStore
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33
34
35
36
37
38
39
40
41
42
43</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 31</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='storage_directory_root identifier id'>storage_directory_root</span><span class='rparen token'>)</span>

  <span class='unless unless kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='directory? fid id'>directory?</span> <span class='storage_directory_root identifier id'>storage_directory_root</span>
    <span class='raise identifier id'>raise</span> <span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;File path '#{storage_directory_root}' is not a directory.&quot;</span>
  <span class='end end kw'>end</span>
  <span class='unless unless kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='readable? fid id'>readable?</span> <span class='storage_directory_root identifier id'>storage_directory_root</span>
    <span class='raise identifier id'>raise</span> <span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;File path '#{storage_directory_root}' is not readable.&quot;</span>
  <span class='end end kw'>end</span>
  <span class='unless unless kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='writable? fid id'>writable?</span> <span class='storage_directory_root identifier id'>storage_directory_root</span>
    <span class='raise identifier id'>raise</span> <span class='ConfigurationError constant id'>ConfigurationError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;File path '#{storage_directory_root}' is not writable.&quot;</span>
  <span class='end end kw'>end</span>
  <span class='@filesystem ivar id'>@filesystem</span> <span class='assign token'>=</span>  <span class='storage_directory_root identifier id'>storage_directory_root</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>%r{/+$}</span><span class='comma token'>,</span> <span class='string val'>''</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <span id="filesystem-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="filesystem-instance_method">
  
    - (<tt>Object</tt>) <strong>filesystem</strong>  <span class="extras">(readonly)</span>
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the value of attribute filesystem
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


17
18
19</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 17</span>

<span class='def def kw'>def</span> <span class='filesystem identifier id'>filesystem</span>
  <span class='@filesystem ivar id'>@filesystem</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="data_path-instance_method">
  
    - (<tt>Object</tt>) <strong>data_path</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


400
401
402</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 400</span>

<span class='def def kw'>def</span> <span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;data&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="datetime-instance_method">
  
    - (<tt>Object</tt>) <strong>datetime</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Return the iso8601 representation of date/time of the data described by
name.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


283
284
285
286
287
288
289
290
291</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 283</span>

<span class='def def kw'>def</span> <span class='datetime identifier id'>datetime</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='datetime_path identifier id'>datetime_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='DateTime constant id'>DateTime</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='f identifier id'>f</span><span class='dot token'>.</span><span class='gets identifier id'>gets</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='ex identifier id'>ex</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't determine the date time for #{describe name}: #{ex.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="datetime_path-instance_method">
  
    - (<tt>Object</tt>) <strong>datetime_path</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


404
405
406</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 404</span>

<span class='def def kw'>def</span> <span class='datetime_path identifier id'>datetime_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;datetime&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="delete-instance_method">
  
    - (<tt>Object</tt>) <strong>delete</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Delete data identified by name. Deletes are done one file at a time with no
recursion.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 215</span>

<span class='def def kw'>def</span> <span class='delete identifier id'>delete</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='write_lock identifier id'>write_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='File constant id'>File</span><span class='dot token'>.</span><span class='chmod identifier id'>chmod</span><span class='lparen token'>(</span><span class='PERMISSIVE_DIRECTORY_PERMISSIONS constant id'>PERMISSIVE_DIRECTORY_PERMISSIONS</span><span class='comma token'>,</span> <span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
      <span class='lbrack token'>[</span> <span class='datetime_path identifier id'>datetime_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
        <span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
        <span class='type_path identifier id'>type_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
        <span class='sha1_path identifier id'>sha1_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
        <span class='md5_path identifier id'>md5_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
        <span class='name_path identifier id'>name_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='rbrack token'>]</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='filename identifier id'>filename</span><span class='bitor op'>|</span> <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='rm identifier id'>rm</span><span class='lparen token'>(</span><span class='filename identifier id'>filename</span><span class='rparen token'>)</span>  <span class='rbrace token'>}</span>
      <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='rmdir identifier id'>rmdir</span> <span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't delete #{describe name}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="describe-instance_method">
  
    - (<tt>Object</tt>) <strong>describe</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Mostly for error messages:
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


426
427
428</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 426</span>

<span class='def def kw'>def</span> <span class='describe identifier id'>describe</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='dstring node'>&quot;'#{name}' (located at '#{path name}')&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="dopen-instance_method">
  
    - (<tt>Object</tt>) <strong>dopen</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
For those times when you really, really need an io object on the data
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


201
202
203
204
205
206
207
208
209
210</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 201</span>

<span class='def def kw'>def</span> <span class='dopen identifier id'>dopen</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span> <span class='unless unless_mod kw'>unless</span> <span class='exists? fid id'>exists?</span> <span class='name identifier id'>name</span>
  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='io identifier id'>io</span><span class='bitor op'>|</span>  <span class='yield yield kw'>yield</span> <span class='io identifier id'>io</span> <span class='rbrace token'>}</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} can't get io object from #{describe name}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="each-instance_method">
  
    - (<tt>Object</tt>) <strong>each</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Used to mixin enumerable&#8217;s such as grep, etc.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


310
311
312
313
314
315
316</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 310</span>

<span class='def def kw'>def</span> <span class='each identifier id'>each</span>
  <span class='Find constant id'>Find</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='filesystem identifier id'>filesystem</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='path identifier id'>path</span><span class='bitor op'>|</span>
    <span class='if if kw'>if</span> <span class='path identifier id'>path</span> <span class='match op'>=~</span> <span class='regexp val'>%r|/([a-f0-9]{3})/[a-f0-9]{29}/name|</span>
        <span class='yield yield kw'>yield</span> <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='io identifier id'>io</span><span class='bitor op'>|</span> <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span> <span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="etag-instance_method">
  
    - (<tt>Object</tt>) <strong>etag</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


304
305
306</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 304</span>

<span class='def def kw'>def</span> <span class='etag identifier id'>etag</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span><span class='lparen token'>(</span><span class='name identifier id'>name</span> <span class='plus op'>+</span> <span class='md5 identifier id'>md5</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="exists?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>exists?</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns true if a data identified by name is in the silo. Warning: this is
a read locked method, do not call when the object is write locked.
</p>


  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54
55
56
57
58
59
60
61</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 52</span>

<span class='def def kw'>def</span> <span class='exists? fid id'>exists?</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='File constant id'>File</span><span class='dot token'>.</span><span class='directory? fid id'>directory?</span> <span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='and and kw'>and</span>
      <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='and and kw'>and</span>
      <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='datetime_path identifier id'>datetime_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='and and kw'>and</span>
      <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='md5_path identifier id'>md5_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='and and kw'>and</span>
      <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='name_path identifier id'>name_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='and and kw'>and</span>
      <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='type_path identifier id'>type_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>                  <span class='comment val'>## TODO: add sh1 here when we've got everything updated (maybe)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get-instance_method">
  
    - (<tt>Object</tt>) <strong>get</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Get data identified by name from the silo. Takes an optional block for
reading.
</p>
<p>
open(&#8220;MyStuff/MyFile&#8221;, &#8220;w&#8221;) do |output|
</p>
<pre class="code">
  <span class='silo identifier id'>silo</span><span class='dot token'>.</span><span class='get identifier id'>get</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='buff identifier id'>buff</span><span class='bitor op'>|</span>
     <span class='output identifier id'>output</span><span class='dot token'>.</span><span class='write identifier id'>write</span> <span class='buff identifier id'>buff</span>
  <span class='end end kw'>end</span>
</pre>
<p>
end
</p>
<p>
or simply:
</p>
<p>
data = silo.get(name)
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 178</span>

<span class='def def kw'>def</span> <span class='get identifier id'>get</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span> <span class='unless unless_mod kw'>unless</span> <span class='exists? fid id'>exists?</span> <span class='name identifier id'>name</span>

  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='io identifier id'>io</span><span class='bitor op'>|</span>
        <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
          <span class='while while kw'>while</span> <span class='buff identifier id'>buff</span> <span class='assign token'>=</span> <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='IO_BUFFER_SIZE constant id'>IO_BUFFER_SIZE</span><span class='rparen token'>)</span>
            <span class='yield yield kw'>yield</span> <span class='buff identifier id'>buff</span>
          <span class='end end kw'>end</span>
        <span class='else else kw'>else</span>
          <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='read identifier id'>read</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} can't get #{describe name}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="invalid_name?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>invalid_name?</strong>(string) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
What&#8217;s in a name?  no embedded control characters, that&#8217;s for
sure.
</p>


  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


371
372
373</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 371</span>

<span class='def def kw'>def</span> <span class='invalid_name? fid id'>invalid_name?</span><span class='lparen token'>(</span><span class='string identifier id'>string</span><span class='rparen token'>)</span>
  <span class='string identifier id'>string</span> <span class='match op'>=~</span> <span class='regexp val'>/[^ a-zA-Z\/.,0-9_+~!\'\&quot;@#*\(\)=-]/</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="last_access-instance_method">
  
    - (<tt>Object</tt>) <strong>last_access</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


293
294
295
296
297
298
299
300
301</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 293</span>

<span class='def def kw'>def</span> <span class='last_access identifier id'>last_access</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='DateTime constant id'>DateTime</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='atime identifier id'>atime</span><span class='lparen token'>(</span><span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='ex identifier id'>ex</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't determine the date time for #{describe name}: #{ex.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="md5-instance_method">
  
    - (<tt>Object</tt>) <strong>md5</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the (saved) md5 hexdigest of data identified by name
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


259
260
261
262
263
264
265
266
267</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 259</span>

<span class='def def kw'>def</span> <span class='md5 identifier id'>md5</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='md5_path identifier id'>md5_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='gets identifier id'>gets</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span> <span class='rbrace token'>}</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't determine md5 for #{describe name}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="md5_path-instance_method">
  
    - (<tt>Object</tt>) <strong>md5_path</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


412
413
414</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 412</span>

<span class='def def kw'>def</span> <span class='md5_path identifier id'>md5_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;md5&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="name_path-instance_method">
  
    - (<tt>Object</tt>) <strong>name_path</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


420
421
422</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 420</span>

<span class='def def kw'>def</span> <span class='name_path identifier id'>name_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;name&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="parent_path-instance_method">
  
    - (<tt>Object</tt>) <strong>parent_path</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


395
396
397
398</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 395</span>

<span class='def def kw'>def</span> <span class='parent_path identifier id'>parent_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span>  <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span> <span class='name identifier id'>name</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='filesystem identifier id'>filesystem</span><span class='comma token'>,</span>  <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='hashpath_parent identifier id'>hashpath_parent</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="path-instance_method">
  
    - (<tt>Object</tt>) <strong>path</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Return the filesystem paths of the various meta/data associated with and
object identified by name.
</p>
<p>
Here are the directories and file layouts: say we have an object named
&#8220;my/stuff.txt&#8221; and silo.filesystem is
&#8220;/tmp/store/&#8221;.  The the md5 checksum of
&#8220;my/stuff.txt&#8221; (of the string itself, not the contents of a
file) is &#8220;9203e38408ebed690ecdf40953558dbb&#8221;. We have the
following:
</p>
<p>
parent_path     /tmp/store/920/  (this is where we create lock files) path 
/tmp/store/920/3e38408ebed690ecdf40953558dbb/ data_path      
/tmp/store/920/3e38408ebed690ecdf40953558dbb/data datetime_path  
/tmp/store/920/3e38408ebed690ecdf40953558dbb/datetime md5_path       
/tmp/store/920/3e38408ebed690ecdf40953558dbb/md5 sha1_path      
/tmp/store/920/3e38408ebed690ecdf40953558dbb/sha1 name_path      
/tmp/store/920/3e38408ebed690ecdf40953558dbb/name type_path      
/tmp/store/920/3e38408ebed690ecdf40953558dbb/type
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


390
391
392
393</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 390</span>

<span class='def def kw'>def</span> <span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span>  <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span> <span class='name identifier id'>name</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='filesystem identifier id'>filesystem</span><span class='comma token'>,</span>  <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='hashpath identifier id'>hashpath</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="put-instance_method">
  
    - (<tt>Object</tt>) <strong>put</strong>(name, data, type) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Put data identified by name in the silo.  Normally data will be some kind
of IO object, but strings (or anything with a to_s method) will work fine.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 66</span>

<span class='def def kw'>def</span> <span class='put identifier id'>put</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='data identifier id'>data</span><span class='comma token'>,</span> <span class='type identifier id'>type</span><span class='rparen token'>)</span>


  <span class='if if kw'>if</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span> <span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
    <span class='raise identifier id'>raise</span> <span class='DiskStoreResourceExists constant id'>DiskStoreResourceExists</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} error - resource #{name} already exists. You must delete this resource first.&quot;</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='gt op'>&gt;</span> <span class='MAX_NAME_LENGTH constant id'>MAX_NAME_LENGTH</span> <span class='or or kw'>or</span> <span class='invalid_name? fid id'>invalid_name?</span> <span class='name identifier id'>name</span><span class='rparen token'>)</span>
    <span class='raise identifier id'>raise</span> <span class='BadName constant id'>BadName</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} error - invalid name for resource '#{name}'.&quot;</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># check for size, if we can</span>

  <span class='disk_free identifier id'>disk_free</span> <span class='assign token'>=</span> <span class='StoreUtils constant id'>StoreUtils</span><span class='dot token'>.</span><span class='disk_free identifier id'>disk_free</span><span class='lparen token'>(</span><span class='filesystem identifier id'>filesystem</span><span class='rparen token'>)</span>

  <span class='data identifier id'>data</span> <span class='assign token'>=</span> <span class='StringIO constant id'>StringIO</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='data identifier id'>data</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='data identifier id'>data</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span> <span class='string val'>&quot;read&quot;</span>

  <span class='if if kw'>if</span> <span class='data identifier id'>data</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span> <span class='string val'>'stat'</span>
    <span class='if if kw'>if</span> <span class='data identifier id'>data</span><span class='dot token'>.</span><span class='stat identifier id'>stat</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='gt op'>&gt;</span> <span class='disk_free identifier id'>disk_free</span>  <span class='minus op'>-</span> <span class='HEADROOM constant id'>HEADROOM</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} can't save #{name} - #{data.stat.size} bytes data &gt; #{disk_free} free disk bytes plus #{HEADROOM} bytes headroom.&quot;</span>
    <span class='end end kw'>end</span>
  <span class='elsif elsif kw'>elsif</span> <span class='data identifier id'>data</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span> <span class='string val'>'size'</span>
    <span class='if if kw'>if</span> <span class='data identifier id'>data</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='gt op'>&gt;</span> <span class='disk_free identifier id'>disk_free</span> <span class='minus op'>-</span> <span class='HEADROOM constant id'>HEADROOM</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} can't save #{name} - #{data.size} bytes data &gt; #{disk_free} free disk bytes plus #{HEADROOM} bytes headroom.&quot;</span>
    <span class='end end kw'>end</span>
  <span class='else else kw'>else</span>
    <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} can't determine the size of #{name} of type #{data.class}, aborting.&quot;</span>
  <span class='end end kw'>end</span>

  <span class='write_lock identifier id'>write_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='mkdir_p identifier id'>mkdir_p</span> <span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} directory creation for #{name} failed: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>

    <span class='metafile identifier id'>metafile</span> <span class='assign token'>=</span> <span class='string val'>''</span>
    <span class='begin begin kw'>begin</span>
      <span class='metafile identifier id'>metafile</span> <span class='assign token'>=</span> <span class='string val'>'data'</span>
      <span class='md5 identifier id'>md5</span>  <span class='assign token'>=</span> <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='MD5 constant id'>MD5</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
      <span class='sha1 identifier id'>sha1</span> <span class='assign token'>=</span> <span class='Digest constant id'>Digest</span><span class='colon2 op'>::</span><span class='SHA1 constant id'>SHA1</span><span class='dot token'>.</span><span class='new identifier id'>new</span>         <span class='comment val'># recent addition - not all old silos will have this, initially (unfortunately)</span>

      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;w&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='output identifier id'>output</span><span class='bitor op'>|</span>
        <span class='while while kw'>while</span> <span class='buff identifier id'>buff</span> <span class='assign token'>=</span> <span class='data identifier id'>data</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='IO_BUFFER_SIZE constant id'>IO_BUFFER_SIZE</span><span class='rparen token'>)</span>
          <span class='md5 identifier id'>md5</span> <span class='lshft op'>&lt;&lt;</span> <span class='buff identifier id'>buff</span>
          <span class='sha1 identifier id'>sha1</span> <span class='lshft op'>&lt;&lt;</span> <span class='buff identifier id'>buff</span>
          <span class='output identifier id'>output</span><span class='dot token'>.</span><span class='write identifier id'>write</span> <span class='buff identifier id'>buff</span>
          <span class='output identifier id'>output</span><span class='dot token'>.</span><span class='fsync identifier id'>fsync</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>

      <span class='metafile identifier id'>metafile</span> <span class='assign token'>=</span> <span class='string val'>'sha1'</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='sha1_path identifier id'>sha1_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;w&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='io identifier id'>io</span><span class='bitor op'>|</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span> <span class='sha1 identifier id'>sha1</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='fsync identifier id'>fsync</span>
      <span class='end end kw'>end</span>

      <span class='metafile identifier id'>metafile</span> <span class='assign token'>=</span> <span class='string val'>'md5'</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='md5_path identifier id'>md5_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;w&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='io identifier id'>io</span><span class='bitor op'>|</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span> <span class='md5 identifier id'>md5</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='fsync identifier id'>fsync</span>
      <span class='end end kw'>end</span>

      <span class='metafile identifier id'>metafile</span> <span class='assign token'>=</span> <span class='string val'>'datetime'</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='datetime_path identifier id'>datetime_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;w&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='io identifier id'>io</span><span class='bitor op'>|</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='dot token'>.</span><span class='iso8601 identifier id'>iso8601</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='fsync identifier id'>fsync</span>
      <span class='end end kw'>end</span>

      <span class='metafile identifier id'>metafile</span> <span class='assign token'>=</span> <span class='string val'>'name'</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='name_path identifier id'>name_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;w&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='io identifier id'>io</span><span class='bitor op'>|</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span> <span class='name identifier id'>name</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='fsync identifier id'>fsync</span>
      <span class='end end kw'>end</span>

      <span class='metafile identifier id'>metafile</span> <span class='assign token'>=</span> <span class='string val'>'type'</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='type_path identifier id'>type_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;w&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='io identifier id'>io</span><span class='bitor op'>|</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span> <span class='type identifier id'>type</span>
        <span class='io identifier id'>io</span><span class='dot token'>.</span><span class='fsync identifier id'>fsync</span>
      <span class='end end kw'>end</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} can't write the '#{metafile}' metafile for  #{name}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>

    <span class='unless unless kw'>unless</span> <span class='integer val'>6</span> <span class='eq op'>==</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='chmod identifier id'>chmod</span><span class='lparen token'>(</span><span class='RESTRICTIVE_FILE_PERMISSIONS constant id'>RESTRICTIVE_FILE_PERMISSIONS</span><span class='comma token'>,</span>
                           <span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                           <span class='datetime_path identifier id'>datetime_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                           <span class='name_path identifier id'>name_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                           <span class='md5_path identifier id'>md5_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                           <span class='sha1_path identifier id'>sha1_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span>
                           <span class='type_path identifier id'>type_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} can't set restrictive permissions on all data files for #{describe name}&quot;</span>
    <span class='end end kw'>end</span>

    <span class='unless unless kw'>unless</span> <span class='integer val'>1</span> <span class='eq op'>==</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='chmod identifier id'>chmod</span><span class='lparen token'>(</span><span class='RESTRICTIVE_DIRECTORY_PERMISSIONS constant id'>RESTRICTIVE_DIRECTORY_PERMISSIONS</span><span class='comma token'>,</span> <span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{self} can't set restrictive permissions on data file directory for #{describe name}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span> <span class='comment val'># write_lock</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="read_lock-instance_method">
  
    - (<tt>Object</tt>) <strong>read_lock</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
read shared lock - any one can get another read lock, but no-one can get an
exclusive (write) lock
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 351</span>

<span class='def def kw'>def</span> <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='begin begin kw'>begin</span>
    <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='mkdir_p identifier id'>mkdir_p</span> <span class='parent_path identifier id'>parent_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
    <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Parent directory creation for #{describe name} failed: #{e.message}&quot;</span>
  <span class='end end kw'>end</span>
  <span class='lockfile identifier id'>lockfile</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='parent_path identifier id'>parent_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='LOCK_FILENAME constant id'>LOCK_FILENAME</span><span class='rparen token'>)</span>

  <span class='begin begin kw'>begin</span>
    <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='lockfile identifier id'>lockfile</span><span class='comma token'>,</span> <span class='string val'>&quot;w&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='lock identifier id'>lock</span><span class='bitor op'>|</span>
      <span class='Timeout constant id'>Timeout</span><span class='dot token'>.</span><span class='timeout identifier id'>timeout</span><span class='lparen token'>(</span><span class='LOCKFILE_GRAB_TIMEOUT constant id'>LOCKFILE_GRAB_TIMEOUT</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='lock identifier id'>lock</span><span class='dot token'>.</span><span class='flock identifier id'>flock</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='colon2 op'>::</span><span class='LOCK_SH constant id'>LOCK_SH</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
      <span class='yield yield kw'>yield</span>
    <span class='end end kw'>end</span>
  <span class='rescue rescue kw'>rescue</span> <span class='Timeout constant id'>Timeout</span><span class='colon2 op'>::</span><span class='Error constant id'>Error</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
    <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Timed out waiting for #{LOCKFILE_GRAB_TIMEOUT} seconds for read lock to #{describe name}: #{e.message}&quot;</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="sha1-instance_method">
  
    - (<tt>Object</tt>) <strong>sha1</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the saved sha1 hexdigest of data
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


271
272
273
274
275
276
277
278
279</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 271</span>

<span class='def def kw'>def</span> <span class='sha1 identifier id'>sha1</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='sha1_path identifier id'>sha1_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='gets identifier id'>gets</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span> <span class='rbrace token'>}</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't determine sha1 for #{describe name}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="sha1_path-instance_method">
  
    - (<tt>Object</tt>) <strong>sha1_path</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


416
417
418</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 416</span>

<span class='def def kw'>def</span> <span class='sha1_path identifier id'>sha1_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;sha1&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="size-instance_method">
  
    - (<tt>Object</tt>) <strong>size</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Return the size (in bytes) of the data described by name.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


235
236
237
238
239
240
241
242
243</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 235</span>

<span class='def def kw'>def</span> <span class='size identifier id'>size</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='File constant id'>File</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='data_path identifier id'>data_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't determine size for #{describe name}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="to_s-instance_method">
  
    - (<tt>Object</tt>) <strong>to_s</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 45</span>

<span class='def def kw'>def</span> <span class='to_s identifier id'>to_s</span>
  <span class='dstring node'>&quot;#&lt;DiskStorage: #{self.filesystem}&gt;&quot;</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="type-instance_method">
  
    - (<tt>Object</tt>) <strong>type</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns the content type of the data
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 247</span>

<span class='def def kw'>def</span> <span class='type identifier id'>type</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='read_lock identifier id'>read_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='type_path identifier id'>type_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='gets identifier id'>gets</span><span class='dot token'>.</span><span class='chomp identifier id'>chomp</span> <span class='rbrace token'>}</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Can't determine type for #{describe name}: #{e.message}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="type_path-instance_method">
  
    - (<tt>Object</tt>) <strong>type_path</strong>(name) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


408
409
410</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 408</span>

<span class='def def kw'>def</span> <span class='type_path identifier id'>type_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>&quot;type&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="write_lock-instance_method">
  
    - (<tt>Object</tt>) <strong>write_lock</strong>(name) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Write and read use fstat to lock: once a write lock is acquired, no one
else can get a lock to read (a shared lock) or write (an exclusive lock).
The way it works is this: you can have as many read locks as you want, but
the OS guarantees that there will be never more than one write lock on a
filehandle, nor will it allow a write lock and read lock exist at the same
time.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/Users/fischer/WorkProjects/daitss2/store-master/lib/store/diskstore.rb', line 332</span>

<span class='def def kw'>def</span> <span class='write_lock identifier id'>write_lock</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='begin begin kw'>begin</span>
    <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='mkdir_p identifier id'>mkdir_p</span> <span class='parent_path identifier id'>parent_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
    <span class='raise identifier id'>raise</span> <span class='DiskStoreError constant id'>DiskStoreError</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Parent directory creation for #{describe name} failed: #{e.message}&quot;</span>
  <span class='end end kw'>end</span>
  <span class='lockfile identifier id'>lockfile</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='parent_path identifier id'>parent_path</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='LOCK_FILENAME constant id'>LOCK_FILENAME</span><span class='rparen token'>)</span>

  <span class='begin begin kw'>begin</span>
    <span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='lockfile identifier id'>lockfile</span><span class='comma token'>,</span> <span class='string val'>&quot;w&quot;</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='lock identifier id'>lock</span><span class='bitor op'>|</span>
      <span class='Timeout constant id'>Timeout</span><span class='dot token'>.</span><span class='timeout identifier id'>timeout</span><span class='lparen token'>(</span><span class='LOCKFILE_GRAB_TIMEOUT constant id'>LOCKFILE_GRAB_TIMEOUT</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='lock identifier id'>lock</span><span class='dot token'>.</span><span class='flock identifier id'>flock</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='colon2 op'>::</span><span class='LOCK_EX constant id'>LOCK_EX</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
      <span class='yield yield kw'>yield</span>
    <span class='end end kw'>end</span>
  <span class='rescue rescue kw'>rescue</span> <span class='Timeout constant id'>Timeout</span><span class='colon2 op'>::</span><span class='Error constant id'>Error</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Thu Dec  2 14:52:48 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.0 (ruby-1.8.7).
</div>

  </body>
</html>